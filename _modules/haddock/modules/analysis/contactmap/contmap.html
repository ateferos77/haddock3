<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>haddock.modules.analysis.contactmap.contmap &mdash; haddock3 3.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
        <script src="../../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            haddock3
          </a>
              <div class="version">
                3.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro.html">A brief introduction to HADDOCK3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../INSTALL.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../INSTALL.html#installing-third-party-packages">Installing third-party packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../USAGE.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../examples.html">Workflow Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/index.html">Advanced features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../clients/haddock.clis.html">Command-line interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modules/index.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../testing/index.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../contributing.html">Contributing to HADDOCK3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../citing.html">Citing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../reference/index.html">Library Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">haddock3</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../haddock.html">haddock</a></li>
          <li class="breadcrumb-item"><a href="../../../modules.html">haddock.modules</a></li>
          <li class="breadcrumb-item"><a href="../../analysis.html">haddock.modules.analysis</a></li>
          <li class="breadcrumb-item"><a href="../contactmap.html">haddock.modules.analysis.contactmap</a></li>
      <li class="breadcrumb-item active">haddock.modules.analysis.contactmap.contmap</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for haddock.modules.analysis.contactmap.contmap</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module computing contact maps of complexes, alone or grouped by cluster.</span>

<span class="sd">Chord diagram functions were adapted from:</span>
<span class="sd">https://plotly.com/python/v3/filled-chord-diagram/</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objs</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">pdist</span><span class="p">,</span> <span class="n">squareform</span>

<span class="kn">from</span> <span class="nn">haddock</span> <span class="kn">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">haddock.libs.libontology</span> <span class="kn">import</span> <span class="n">PDBFile</span>
<span class="kn">from</span> <span class="nn">haddock.libs.libpdb</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">slc_name</span><span class="p">,</span>
    <span class="n">slc_resname</span><span class="p">,</span>
    <span class="n">slc_chainid</span><span class="p">,</span>
    <span class="n">slc_resseq</span><span class="p">,</span>
    <span class="n">slc_x</span><span class="p">,</span>
    <span class="n">slc_y</span><span class="p">,</span>
    <span class="n">slc_z</span><span class="p">,</span>
    <span class="p">)</span>
<span class="kn">from</span> <span class="nn">haddock.core.typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">NDFloat</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">haddock.libs.libplots</span> <span class="kn">import</span> <span class="n">heatmap_plotly</span>


<span class="c1">###############################</span>
<span class="c1"># Global variable definitions #</span>
<span class="c1">###############################</span>
<span class="n">RESIDUE_POLARITY</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;CYS&quot;</span><span class="p">:</span> <span class="s2">&quot;polar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HIS&quot;</span><span class="p">:</span> <span class="s2">&quot;polar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ASN&quot;</span><span class="p">:</span> <span class="s2">&quot;polar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GLN&quot;</span><span class="p">:</span> <span class="s2">&quot;polar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SER&quot;</span><span class="p">:</span> <span class="s2">&quot;polar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;THR&quot;</span><span class="p">:</span> <span class="s2">&quot;polar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TYR&quot;</span><span class="p">:</span> <span class="s2">&quot;polar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRP&quot;</span><span class="p">:</span> <span class="s2">&quot;polar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ALA&quot;</span><span class="p">:</span> <span class="s2">&quot;apolar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PHE&quot;</span><span class="p">:</span> <span class="s2">&quot;apolar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GLY&quot;</span><span class="p">:</span> <span class="s2">&quot;apolar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ILE&quot;</span><span class="p">:</span> <span class="s2">&quot;apolar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;VAL&quot;</span><span class="p">:</span> <span class="s2">&quot;apolar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MET&quot;</span><span class="p">:</span> <span class="s2">&quot;apolar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PRO&quot;</span><span class="p">:</span> <span class="s2">&quot;apolar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LEU&quot;</span><span class="p">:</span> <span class="s2">&quot;apolar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GLU&quot;</span><span class="p">:</span> <span class="s2">&quot;negative&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ASP&quot;</span><span class="p">:</span> <span class="s2">&quot;negative&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LYS&quot;</span><span class="p">:</span> <span class="s2">&quot;positive&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ARG&quot;</span><span class="p">:</span> <span class="s2">&quot;positive&quot;</span><span class="p">,</span>
    <span class="p">}</span>

<span class="n">PI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

<span class="c1"># Define interaction types colors</span>
<span class="n">CONNECT_COLORS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;polar-polar&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">153</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">153</span><span class="p">),</span>
    <span class="s2">&quot;polar-apolar&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">204</span><span class="p">),</span>
    <span class="s2">&quot;polar-negative&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">153</span><span class="p">),</span>
    <span class="s2">&quot;polar-positive&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">153</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
    <span class="s2">&quot;apolar-apolar&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s2">&quot;apolar-negative&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">204</span><span class="p">),</span>
    <span class="s2">&quot;apolar-positive&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
    <span class="s2">&quot;negative-negative&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s2">&quot;negative-positive&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s2">&quot;positive-positive&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">}</span>
<span class="c1"># Also add reversed keys order</span>
<span class="n">reversed_keys_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span> <span class="n">v</span>
                      <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">CONNECT_COLORS</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">CONNECT_COLORS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reversed_keys_dict</span><span class="p">)</span>

<span class="c1"># Colors for each residue</span>
<span class="n">RESIDUES_COLORS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;CYS&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(229, 255, 204, 0.80)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MET&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(229, 255, 204, 0.80)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ASN&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(128, 255, 0, 0.80)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GLN&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(128, 255, 0, 0.80)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SER&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(153, 255, 51, 0.80)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;THR&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(153, 255, 51, 0.80)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TYR&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(204, 155, 53, 0.80)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRP&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(204, 155, 53, 0.80)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HIS&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(204, 155, 53, 0.80)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PHE&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(255, 255, 51, 0.80)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ALA&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(255, 255, 0, 0.80)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ILE&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(255, 255, 0, 0.80)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;VAL&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(255, 255, 0, 0.80)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PRO&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(255, 255, 0 0.80)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LEU&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(255, 255, 0, 0.80)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GLY&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(255, 255, 255, 0.80)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GLU&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(255, 0, 0, 0.80)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ASP&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(255, 0, 0, 0.80)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LYS&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(0, 0, 255, 0.80)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ARG&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(0, 0, 255, 0.80)&quot;</span><span class="p">,</span>
    <span class="p">}</span>

<span class="c1"># Chain colors ( in +- pymol order )</span>
<span class="n">CHAIN_COLORS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;rgba(51, 255, 51, 0.85)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rgba(51, 153, 255, 0.85)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rgba(255, 153, 51, 0.85)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rgba(255, 255, 51, 0.85)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rgba(255, 0, 0, 0.85)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rgba(255, 0, 127, 0.85)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rgba(0, 255, 0, 0.85)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rgba(0, 0, 255, 0.85)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rgba(0, 153, 0, 0.85)&#39;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="n">CHAIN_COLORS</span> <span class="o">=</span> <span class="n">CHAIN_COLORS</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="c1">##################</span>
<span class="c1"># Define classes #</span>
<span class="c1">##################</span>
<div class="viewcode-block" id="ContactsMap"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.ContactsMap">[docs]</a><span class="k">class</span> <span class="nc">ContactsMap</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ContactMap analysis for single structure.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>

<div class="viewcode-block" id="ContactsMap.run"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.ContactsMap.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process analysis of contacts of a PDB structure.&quot;&quot;&quot;</span>
        <span class="c1"># Load pdb</span>
        <span class="n">pdb_dt</span> <span class="o">=</span> <span class="n">extract_pdb_dt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="c1"># Extract all cordinates</span>
        <span class="n">all_coords</span><span class="p">,</span> <span class="n">resid_keys</span><span class="p">,</span> <span class="n">resid_dt</span> <span class="o">=</span> <span class="n">get_ordered_coords</span><span class="p">(</span><span class="n">pdb_dt</span><span class="p">)</span>
        <span class="c1"># Compute distance matrix</span>
        <span class="n">full_dist_matrix</span> <span class="o">=</span> <span class="n">compute_distance_matrix</span><span class="p">(</span><span class="n">all_coords</span><span class="p">)</span>

        <span class="n">res_res_contacts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># First loop over residues</span>
        <span class="k">for</span> <span class="n">ri</span><span class="p">,</span> <span class="n">reskey_1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">resid_keys</span><span class="p">):</span>
            <span class="c1"># Second loop over residues</span>
            <span class="k">for</span> <span class="n">_rj</span><span class="p">,</span> <span class="n">reskey_2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">resid_keys</span><span class="p">[</span><span class="n">ri</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">start</span><span class="o">=</span><span class="n">ri</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">contact_dt</span> <span class="o">=</span> <span class="n">gen_contact_dt</span><span class="p">(</span>
                    <span class="n">full_dist_matrix</span><span class="p">,</span>
                    <span class="n">resid_dt</span><span class="p">,</span>
                    <span class="n">reskey_1</span><span class="p">,</span>
                    <span class="n">reskey_2</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">res_res_contacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contact_dt</span><span class="p">)</span>

        <span class="c1"># generate outputs for single models</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;single_model_analysis&#39;</span><span class="p">]:</span>

            <span class="c1"># write contacts</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res1&#39;</span><span class="p">,</span> <span class="s1">&#39;res2&#39;</span><span class="p">]</span>
            <span class="n">header</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">res_res_contacts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span>
                <span class="p">]</span>
            <span class="n">fpath</span> <span class="o">=</span> <span class="n">write_res_contacts</span><span class="p">(</span>
                <span class="n">res_res_contacts</span><span class="p">,</span>
                <span class="n">header</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="si">}</span><span class="s1">_contacts.tsv&#39;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated contacts file: </span><span class="si">{</span><span class="n">fpath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Genreate corresponding heatmap</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;generate_heatmap&#39;</span><span class="p">]:</span>
                <span class="n">heatmap</span> <span class="o">=</span> <span class="n">tsv_to_heatmap</span><span class="p">(</span>
                    <span class="n">fpath</span><span class="p">,</span>
                    <span class="n">data_key</span><span class="o">=</span><span class="s1">&#39;ca-ca-dist&#39;</span><span class="p">,</span>
                    <span class="n">contact_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;ca_ca_dist_threshold&#39;</span><span class="p">],</span>
                    <span class="n">colorscale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;color_ramp&#39;</span><span class="p">],</span>
                    <span class="n">output_fname</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="si">}</span><span class="s1">_heatmap.html&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated single model heatmap file: </span><span class="si">{</span><span class="n">heatmap</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Generate corresponding chord chart</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;generate_chordchart&#39;</span><span class="p">]:</span>
                <span class="c1"># find theshold type</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;chordchart_datatype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ca-ca-dist&#39;</span><span class="p">:</span>
                    <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;ca_ca_dist_threshold&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;shortest_dist_threshold&#39;</span><span class="p">]</span>
                <span class="n">chordp</span> <span class="o">=</span> <span class="n">tsv_to_chordchart</span><span class="p">(</span>
                    <span class="n">fpath</span><span class="p">,</span>
                    <span class="n">data_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;chordchart_datatype&#39;</span><span class="p">],</span>
                    <span class="n">contact_threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
                    <span class="n">output_fname</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="si">}</span><span class="s1">_chordchart.html&#39;</span><span class="p">,</span>
                    <span class="n">filter_intermolecular_contacts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated single model chordchart file: </span><span class="si">{</span><span class="n">chordp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res_res_contacts</span></div></div>


<div class="viewcode-block" id="ClusteredContactMap"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.ClusteredContactMap">[docs]</a><span class="k">class</span> <span class="nc">ClusteredContactMap</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ContactMap analysis for set of clustered structures.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">models</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span>
            <span class="n">output</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
            <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminated</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="ClusteredContactMap.run"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.ClusteredContactMap.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process analysis of contacts of a set of PDB structures.&quot;&quot;&quot;</span>
        <span class="c1"># initiate holding variables</span>
        <span class="n">clusters_contacts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">keys_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># loop over models/structures</span>
        <span class="k">for</span> <span class="n">pdb_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="c1"># initiate object</span>
            <span class="n">contact_map_obj</span> <span class="o">=</span> <span class="n">ContactsMap</span><span class="p">(</span>
                <span class="n">pdb_path</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">pdb_path</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># Run it</span>
            <span class="n">pdb_contacts</span> <span class="o">=</span> <span class="n">contact_map_obj</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="c1"># Parse outputs</span>
            <span class="k">for</span> <span class="n">cont</span> <span class="ow">in</span> <span class="n">pdb_contacts</span><span class="p">:</span>
                <span class="c1"># Check key</span>
                <span class="n">combined_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cont</span><span class="p">[</span><span class="s2">&quot;res2&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">cont</span><span class="p">[</span><span class="s2">&quot;res1&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">if</span> <span class="n">combined_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clusters_contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">combined_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cont</span><span class="p">[</span><span class="s2">&quot;res1&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">cont</span><span class="p">[</span><span class="s2">&quot;res2&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">if</span> <span class="n">combined_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clusters_contacts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">keys_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combined_key</span><span class="p">)</span>
                        <span class="n">clusters_contacts</span><span class="p">[</span><span class="n">combined_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">k</span><span class="p">:</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cont</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;res1&quot;</span><span class="p">,</span> <span class="s2">&quot;res2&quot;</span><span class="p">]</span>
                            <span class="p">}</span>
                <span class="c1"># Add data</span>
                <span class="k">for</span> <span class="n">dtk</span> <span class="ow">in</span> <span class="n">clusters_contacts</span><span class="p">[</span><span class="n">combined_key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">clusters_contacts</span><span class="p">[</span><span class="n">combined_key</span><span class="p">][</span><span class="n">dtk</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cont</span><span class="p">[</span><span class="n">dtk</span><span class="p">])</span>

        <span class="n">combined_clusters_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Loop over ordered keys</span>
        <span class="k">for</span> <span class="n">combined_key</span> <span class="ow">in</span> <span class="n">keys_list</span><span class="p">:</span>
            <span class="c1"># point data</span>
            <span class="n">res1</span><span class="p">,</span> <span class="n">res2</span> <span class="o">=</span> <span class="n">combined_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">clusters_contacts</span><span class="p">[</span><span class="n">combined_key</span><span class="p">]</span>

            <span class="c1"># Compute averages Ca-Ca distances</span>
            <span class="n">avg_ca_ca_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="s1">&#39;ca-ca-dist&#39;</span><span class="p">])</span>
            <span class="c1"># Compute number of time the cluster members holds a value under threshold</span>
            <span class="n">ca_ca_above_thresh</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;ca-ca-dist&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;ca_ca_dist_threshold&#39;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="n">ca_ca_cont_ratio</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ca_ca_above_thresh</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="s1">&#39;ca-ca-dist&#39;</span><span class="p">])</span>

            <span class="c1"># Compute averages for shortest distances</span>
            <span class="n">avg_shortest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="s1">&#39;shortest-dist&#39;</span><span class="p">])</span>
            <span class="c1"># Generate list of shortest distances observed between two residues</span>
            <span class="n">short_ab_t</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;shortest-dist&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;shortest_dist_threshold&#39;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="c1"># Compute number of time the cluster members holds a value under threshold</span>
            <span class="n">shortest_cont_ratio</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">short_ab_t</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="s1">&#39;shortest-dist&#39;</span><span class="p">])</span>

            <span class="c1"># Find most representative contact type</span>
            <span class="n">cont_ts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="s1">&#39;contact-type&#39;</span><span class="p">]))</span>
            <span class="c1"># Decreasing sorting of cluster contact types and pick highest one</span>
            <span class="n">cont_t</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="n">cont_ts</span><span class="p">,</span>
                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">cont_ts</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Compute ratio for this contact type to be found</span>
            <span class="n">cont_t_ratio</span> <span class="o">=</span> <span class="n">cont_ts</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">cont_t</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="s1">&#39;contact-type&#39;</span><span class="p">])</span>

            <span class="c1"># Hold summary data for cluster</span>
            <span class="n">combined_clusters_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;res1&#39;</span><span class="p">:</span> <span class="n">res1</span><span class="p">,</span>
                <span class="s1">&#39;res2&#39;</span><span class="p">:</span> <span class="n">res2</span><span class="p">,</span>
                <span class="s1">&#39;ca-ca-dist&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">avg_ca_ca_dist</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="s1">&#39;ca-ca-cont-ratio&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">ca_ca_cont_ratio</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s1">&#39;shortest-dist&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">avg_shortest</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="s1">&#39;shortest-cont-ratio&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">shortest_cont_ratio</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s1">&#39;contact-type&#39;</span><span class="p">:</span> <span class="n">cont_t</span><span class="p">,</span>
                <span class="s1">&#39;contact-type-ratio&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">cont_t_ratio</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">})</span>
        
        <span class="c1"># write contacts</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res1&#39;</span><span class="p">,</span> <span class="s1">&#39;res2&#39;</span><span class="p">]</span>
        <span class="n">header</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">combined_clusters_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span>
            <span class="p">]</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">write_res_contacts</span><span class="p">(</span>
            <span class="n">combined_clusters_list</span><span class="p">,</span>
            <span class="n">header</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="si">}</span><span class="s1">_contacts.tsv&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated contacts file: </span><span class="si">{</span><span class="n">fpath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Generate corresponding heatmap</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;generate_heatmap&#39;</span><span class="p">]:</span>
            <span class="n">heatmap_path</span> <span class="o">=</span> <span class="n">tsv_to_heatmap</span><span class="p">(</span>
                <span class="n">fpath</span><span class="p">,</span>
                <span class="n">data_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;cluster_heatmap_datatype&#39;</span><span class="p">],</span>
                <span class="n">contact_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">colorscale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;color_ramp&#39;</span><span class="p">],</span>
                <span class="n">output_fname</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="si">}</span><span class="s1">_heatmap.html&#39;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated cluster contacts heatmap: </span><span class="si">{</span><span class="n">heatmap_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Generate corresponding chord chart</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;generate_chordchart&#39;</span><span class="p">]:</span>
            <span class="c1"># find theshold type</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;chordchart_datatype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ca-ca-dist&#39;</span><span class="p">:</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;ca_ca_dist_threshold&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;shortest_dist_threshold&#39;</span><span class="p">]</span>
            <span class="n">chordp</span> <span class="o">=</span> <span class="n">tsv_to_chordchart</span><span class="p">(</span>
                <span class="n">fpath</span><span class="p">,</span>
                <span class="n">data_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;chordchart_datatype&#39;</span><span class="p">],</span>
                <span class="n">contact_threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
                <span class="n">output_fname</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="si">}</span><span class="s1">_chordchart.html&#39;</span><span class="p">,</span>
                <span class="n">filter_intermolecular_contacts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated cluster contacts chordchart file: </span><span class="si">{</span><span class="n">chordp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">terminated</span> <span class="o">=</span> <span class="kc">True</span></div></div>


<div class="viewcode-block" id="get_clusters_sets"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.get_clusters_sets">[docs]</a><span class="k">def</span> <span class="nf">get_clusters_sets</span><span class="p">(</span><span class="n">models</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PDBFile</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Split models by clusters ids.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    models : list</span>
<span class="sd">        List of pdb models/complexes.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    clusters_sets : dict</span>
<span class="sd">        Dictionary of models acccessible by their cluster ids as keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clusters_sets</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">clt_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clusters_sets</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">clusters_sets</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">clt_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">clusters_sets</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">clt_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clusters_sets</span></div>


<div class="viewcode-block" id="topX_models"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.topX_models">[docs]</a><span class="k">def</span> <span class="nf">topX_models</span><span class="p">(</span><span class="n">models</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PDBFile</span><span class="p">],</span> <span class="n">topX</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sort and return subset of top X best models.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    models : list</span>
<span class="sd">        List of pdb models/complexes.</span>
<span class="sd">    topX : int</span>
<span class="sd">        Number of models to return after sorting.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    subset_bests : list</span>
<span class="sd">        List of top `X` best models.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sorted_models</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">sorted_models</span> <span class="o">=</span> <span class="n">models</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">subset_bests</span> <span class="o">=</span> <span class="n">sorted_models</span><span class="p">[:</span><span class="n">topX</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">subset_bests</span></div>


<span class="c1">####################</span>
<span class="c1"># Define functions #</span>
<span class="c1">####################</span>
<div class="viewcode-block" id="extract_pdb_dt"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.extract_pdb_dt">[docs]</a><span class="k">def</span> <span class="nf">extract_pdb_dt</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read and extract ATOM/HETATM records from a pdb file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : Path</span>
<span class="sd">        Path to a pdb file.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    pdb_chains : dict</span>
<span class="sd">        A dictionary of the pdb file accesible using chains as keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pdb_chains</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;chain_order&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="c1"># Read file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># Loop over lines</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># Skip non ATOM / HETATM lines</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span>
               <span class="n">_</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ATOM&#39;</span><span class="p">),</span>
               <span class="n">_</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;HETATM&#39;</span><span class="p">),</span>
               <span class="p">]):</span>
                <span class="k">continue</span>

            <span class="c1"># Extract residue name</span>
            <span class="n">resname</span> <span class="o">=</span> <span class="n">_</span><span class="p">[</span><span class="n">slc_resname</span><span class="p">]</span>
            <span class="c1"># Extract chain id</span>
            <span class="n">chainid</span> <span class="o">=</span> <span class="n">_</span><span class="p">[</span><span class="n">slc_chainid</span><span class="p">]</span>
            <span class="c1"># Extract resid</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="n">_</span><span class="p">[</span><span class="n">slc_resseq</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c1"># Check if chain already parsed</span>
            <span class="k">if</span> <span class="n">chainid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pdb_chains</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># Add to ordered chains</span>
                <span class="n">pdb_chains</span><span class="p">[</span><span class="s1">&#39;chain_order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chainid</span><span class="p">)</span>
                <span class="c1"># Initiate new chain holder</span>
                <span class="n">pdb_chains</span><span class="p">[</span><span class="n">chainid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="p">[]}</span>

            <span class="c1"># Check if new resid id</span>
            <span class="k">if</span> <span class="n">resid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pdb_chains</span><span class="p">[</span><span class="n">chainid</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># Add to oredered resids</span>
                <span class="n">pdb_chains</span><span class="p">[</span><span class="n">chainid</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
                <span class="c1"># Initiate new residue holder</span>
                <span class="n">pdb_chains</span><span class="p">[</span><span class="n">chainid</span><span class="p">][</span><span class="n">resid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdb_chains</span><span class="p">[</span><span class="n">chainid</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;resname&#39;</span><span class="p">:</span> <span class="n">resname</span><span class="p">,</span>
                    <span class="s1">&#39;chainid&#39;</span><span class="p">:</span> <span class="n">chainid</span><span class="p">,</span>
                    <span class="s1">&#39;resid&#39;</span><span class="p">:</span> <span class="n">resid</span><span class="p">,</span>
                    <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdb_chains</span><span class="p">[</span><span class="n">chainid</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">]),</span>
                    <span class="s1">&#39;atoms_order&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;atoms&#39;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="p">}</span>
            <span class="c1"># extract atome name</span>
            <span class="n">atname</span> <span class="o">=</span> <span class="n">_</span><span class="p">[</span><span class="n">slc_name</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># check if not an hydrogen</span>
            <span class="k">if</span> <span class="n">atname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># extact atome coordinates</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">extract_pdb_coords</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
            <span class="n">pdb_chains</span><span class="p">[</span><span class="n">chainid</span><span class="p">][</span><span class="n">resid</span><span class="p">][</span><span class="s1">&#39;atoms_order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atname</span><span class="p">)</span>
            <span class="n">pdb_chains</span><span class="p">[</span><span class="n">chainid</span><span class="p">][</span><span class="n">resid</span><span class="p">][</span><span class="s1">&#39;atoms&#39;</span><span class="p">][</span><span class="n">atname</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span>

    <span class="k">return</span> <span class="n">pdb_chains</span></div>


<div class="viewcode-block" id="extract_pdb_coords"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.extract_pdb_coords">[docs]</a><span class="k">def</span> <span class="nf">extract_pdb_coords</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract coordinated from a PDB line.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    line : str</span>
<span class="sd">        A strandard ATOM/HETATM pdb record.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    coords : list[float]</span>
<span class="sd">        List of the X, Y and Z coordinate of this atom.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">slc_x</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">slc_y</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">z</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">slc_z</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">coords</span></div>


<div class="viewcode-block" id="get_ordered_coords"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.get_ordered_coords">[docs]</a><span class="k">def</span> <span class="nf">get_ordered_coords</span><span class="p">(</span>
        <span class="n">pdb_chains</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate list of all atom coordinates.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pdb_chains : dict</span>
<span class="sd">        A dictionary of the pdb file accesible using chains as keys,</span>
<span class="sd">         as provided by the `extract_pdb_dt()` function.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    all_coords : list[list[float]]</span>
<span class="sd">        All atomic coordinates in a single list.</span>
<span class="sd">    resid_keys : list[str]</span>
<span class="sd">        Ordered list of residues keys.</span>
<span class="sd">    resid_dt : dict</span>
<span class="sd">        Dictionary of coordinates indices for each residue.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define holders</span>
    <span class="n">all_coords</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">resid_keys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">resid_dt</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Loop over chains</span>
    <span class="k">for</span> <span class="n">chainid</span> <span class="ow">in</span> <span class="n">pdb_chains</span><span class="p">[</span><span class="s1">&#39;chain_order&#39;</span><span class="p">]:</span>
        <span class="c1"># Loop over residues of this chain</span>
        <span class="k">for</span> <span class="n">resid</span> <span class="ow">in</span> <span class="n">pdb_chains</span><span class="p">[</span><span class="n">chainid</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">]:</span>
            <span class="c1"># create a resdiue key</span>
            <span class="n">resname</span> <span class="o">=</span> <span class="n">pdb_chains</span><span class="p">[</span><span class="n">chainid</span><span class="p">][</span><span class="n">resid</span><span class="p">][</span><span class="s1">&#39;resname&#39;</span><span class="p">]</span>
            <span class="n">reskey</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">chainid</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">resid</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">resname</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">resdt</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;atoms_indices&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s1">&#39;resname&#39;</span><span class="p">:</span> <span class="n">resname</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="c1"># Loop over atoms of this residue</span>
            <span class="k">for</span> <span class="n">atname</span> <span class="ow">in</span> <span class="n">pdb_chains</span><span class="p">[</span><span class="n">chainid</span><span class="p">][</span><span class="n">resid</span><span class="p">][</span><span class="s1">&#39;atoms_order&#39;</span><span class="p">]:</span>
                <span class="c1"># list of internal indices</span>
                <span class="n">resdt</span><span class="p">[</span><span class="s1">&#39;atoms_indices&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="c1"># index of a CA</span>
                <span class="k">if</span> <span class="n">atname</span> <span class="o">==</span> <span class="s1">&#39;CA&#39;</span><span class="p">:</span>
                    <span class="n">resdt</span><span class="p">[</span><span class="s1">&#39;CA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="c1"># Point atome cooct_submatrixrdinate</span>
                <span class="n">all_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdb_chains</span><span class="p">[</span><span class="n">chainid</span><span class="p">][</span><span class="n">resid</span><span class="p">][</span><span class="s1">&#39;atoms&#39;</span><span class="p">][</span><span class="n">atname</span><span class="p">])</span>
                <span class="c1"># increment atom index</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">resid_dt</span><span class="p">[</span><span class="n">reskey</span><span class="p">]</span> <span class="o">=</span> <span class="n">resdt</span>
            <span class="n">resid_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reskey</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">all_coords</span><span class="p">,</span> <span class="n">resid_keys</span><span class="p">,</span> <span class="n">resid_dt</span><span class="p">)</span></div>


<div class="viewcode-block" id="compute_distance_matrix"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.compute_distance_matrix">[docs]</a><span class="k">def</span> <span class="nf">compute_distance_matrix</span><span class="p">(</span><span class="n">all_atm_coords</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">NDFloat</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute all vs all distance matrix.</span>

<span class="sd">    Paramaters</span>
<span class="sd">    ----------</span>
<span class="sd">    all_atm_coords : list[list[float]]</span>
<span class="sd">        List of atomic coordinates.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    dist_matrix : NDFloat</span>
<span class="sd">        N*N distance matrix between all coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">squareform</span><span class="p">(</span><span class="n">pdist</span><span class="p">(</span><span class="n">all_atm_coords</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dist_matrix</span></div>


<div class="viewcode-block" id="extract_submatrix"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.extract_submatrix">[docs]</a><span class="k">def</span> <span class="nf">extract_submatrix</span><span class="p">(</span>
        <span class="n">matrix</span><span class="p">:</span> <span class="n">NDFloat</span><span class="p">,</span>
        <span class="n">indices</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">indices2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDFloat</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract submatrix based on desired indices.</span>

<span class="sd">    Paramaters</span>
<span class="sd">    ----------</span>
<span class="sd">    matrix : NDFloat</span>
<span class="sd">        A N*N matrix.</span>
<span class="sd">    indices : list[int]</span>
<span class="sd">        List of `row` indices to extract from this matrix</span>
<span class="sd">    indices2 : list[int]</span>
<span class="sd">        List of `columns` indices to extract from this matrix.</span>
<span class="sd">         if unspecified, indices2 == indices and symetric matrix</span>
<span class="sd">         is extracted.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    submat : NDFloat</span>
<span class="sd">        The extracted submatrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set second set of indices (columns) to first if not defined</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">indices2</span><span class="p">:</span>
        <span class="n">indices2</span> <span class="o">=</span> <span class="n">indices</span>
    <span class="c1"># extract submatrix</span>
    <span class="n">submat</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">indices2</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">submat</span></div>


<div class="viewcode-block" id="gen_contact_dt"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.gen_contact_dt">[docs]</a><span class="k">def</span> <span class="nf">gen_contact_dt</span><span class="p">(</span>
        <span class="n">matrix</span><span class="p">:</span> <span class="n">NDFloat</span><span class="p">,</span>
        <span class="n">resdt</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">res1_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">res2_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate contacts data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    matrix : NDFloat</span>
<span class="sd">        The distance matrix.</span>
<span class="sd">    resdt : dict</span>
<span class="sd">        Residues data with atom indices as returned by `get_ordered_coords()`.</span>
<span class="sd">    res1_key : str</span>
<span class="sd">        First residue of interest.</span>
<span class="sd">    res2_key : str</span>
<span class="sd">        Second residue of interest</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    cont_dt : dict</span>
<span class="sd">        Dictionary holding contact data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># point residues data</span>
    <span class="n">res1_dt</span> <span class="o">=</span> <span class="n">resdt</span><span class="p">[</span><span class="n">res1_key</span><span class="p">]</span>
    <span class="n">res2_dt</span> <span class="o">=</span> <span class="n">resdt</span><span class="p">[</span><span class="n">res2_key</span><span class="p">]</span>
    <span class="c1"># point ca-ca dist</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ca_ca_dist</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">res1_dt</span><span class="p">[</span><span class="s1">&#39;CA&#39;</span><span class="p">],</span> <span class="n">res2_dt</span><span class="p">[</span><span class="s1">&#39;CA&#39;</span><span class="p">]]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">ca_ca_dist</span> <span class="o">=</span> <span class="mi">9999</span>
    <span class="c1"># obtain submatrix</span>
    <span class="n">res1_res2_atm_submat</span> <span class="o">=</span> <span class="n">extract_submatrix</span><span class="p">(</span>
        <span class="n">matrix</span><span class="p">,</span>
        <span class="n">res1_dt</span><span class="p">[</span><span class="s1">&#39;atoms_indices&#39;</span><span class="p">],</span>
        <span class="n">res2_dt</span><span class="p">[</span><span class="s1">&#39;atoms_indices&#39;</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="c1"># obtain clostest contact</span>
    <span class="n">clostest_contact</span> <span class="o">=</span> <span class="n">min_dist</span><span class="p">(</span><span class="n">res1_res2_atm_submat</span><span class="p">)</span>
    <span class="c1"># contact type</span>
    <span class="n">cont_type</span> <span class="o">=</span> <span class="n">get_cont_type</span><span class="p">(</span><span class="n">res1_dt</span><span class="p">[</span><span class="s1">&#39;resname&#39;</span><span class="p">],</span> <span class="n">res2_dt</span><span class="p">[</span><span class="s1">&#39;resname&#39;</span><span class="p">])</span>
    <span class="c1"># set return variable</span>
    <span class="n">cont_dt</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;res1&#39;</span><span class="p">:</span> <span class="n">res1_key</span><span class="p">,</span>
        <span class="s1">&#39;res2&#39;</span><span class="p">:</span> <span class="n">res2_key</span><span class="p">,</span>
        <span class="s1">&#39;ca-ca-dist&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">ca_ca_dist</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="s1">&#39;shortest-dist&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">clostest_contact</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="s1">&#39;contact-type&#39;</span><span class="p">:</span> <span class="n">cont_type</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="n">cont_dt</span></div>


<div class="viewcode-block" id="get_cont_type"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.get_cont_type">[docs]</a><span class="k">def</span> <span class="nf">get_cont_type</span><span class="p">(</span><span class="n">resn1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resn2</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate polarity key between two residues.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    resn1 : str</span>
<span class="sd">       3 letters code of fist residue.</span>
<span class="sd">    resn2 : str</span>
<span class="sd">       3 letters code of second residue.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    pol_key : str</span>
<span class="sd">        Combined residues polarities</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pol_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">resn</span> <span class="ow">in</span> <span class="p">[</span><span class="n">resn1</span><span class="p">,</span> <span class="n">resn2</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">resn</span> <span class="ow">in</span> <span class="n">RESIDUE_POLARITY</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">pol_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RESIDUE_POLARITY</span><span class="p">[</span><span class="n">resn</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pol_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;unknow&#39;</span><span class="p">)</span>
    <span class="n">pol_key</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pol_keys</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pol_key</span></div>


<div class="viewcode-block" id="min_dist"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.min_dist">[docs]</a><span class="k">def</span> <span class="nf">min_dist</span><span class="p">(</span><span class="n">matrix</span><span class="p">:</span> <span class="n">NDFloat</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find minimum value in a matrix.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_res_contacts"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.write_res_contacts">[docs]</a><span class="k">def</span> <span class="nf">write_res_contacts</span><span class="p">(</span>
        <span class="n">res_res_contacts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
        <span class="n">header</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write a tsv file based on residues-residues contacts data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    res_res_contacts : list[dict]</span>
<span class="sd">        List of dict holding data for each residue-residue contacts.</span>
<span class="sd">    header : list[str]</span>
<span class="sd">        Ordered list of keys to access in the dicts.</span>
<span class="sd">    path : Path</span>
<span class="sd">        Path to the output file to generate.</span>
<span class="sd">    sep : str</span>
<span class="sd">        Character used to separate data within a line.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    path : Path</span>
<span class="sd">        Path to the generated file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># define readme data type content</span>
    <span class="n">dttype_info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;res1&#39;</span><span class="p">:</span> <span class="s1">&#39;Chain-Resname-ResID key identifying first residue&#39;</span><span class="p">,</span>
        <span class="s1">&#39;res2&#39;</span><span class="p">:</span> <span class="s1">&#39;Chain-Resname-ResID key identifying second residue&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ca-ca-dist&#39;</span><span class="p">:</span> <span class="s1">&#39;observed distances between the two Ca&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ca-ca-cont-ratio&#39;</span><span class="p">:</span> <span class="s1">&#39;ratio of times the ca-ca-dist was observed under threshold&#39;</span><span class="p">,</span>  <span class="c1"># noqa : E501</span>
        <span class="s1">&#39;shortest-dist&#39;</span><span class="p">:</span> <span class="s1">&#39;observed shortest distance between the two residues&#39;</span><span class="p">,</span>
        <span class="s1">&#39;shortest-cont-ratio&#39;</span><span class="p">:</span> <span class="s1">&#39;ratio of times the shortest distance was observed under threshold&#39;</span><span class="p">,</span>  <span class="c1"># noqa : E501</span>
        <span class="s1">&#39;contact-type&#39;</span><span class="p">:</span> <span class="s1">&#39;type of contacts between the two residues&#39;</span><span class="p">,</span>
        <span class="s1">&#39;contact-type-ratio&#39;</span><span class="p">:</span> <span class="s1">&#39;ratio of times the type of contacts between the two residues is observed&#39;</span><span class="p">,</span>  <span class="c1"># noqa : E501</span>
        <span class="p">}</span>

    <span class="c1"># initiate file content</span>
    <span class="n">tsvdt</span> <span class="o">=</span> <span class="p">[</span><span class="n">header</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">res_res_cont</span> <span class="ow">in</span> <span class="n">res_res_contacts</span><span class="p">:</span>
        <span class="n">tsvdt</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">res_res_cont</span><span class="p">[</span><span class="n">h</span><span class="p">])</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">header</span><span class="p">])</span>
    <span class="n">tsv_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tsvdt</span><span class="p">])</span>

    <span class="c1"># generate commented lines to be placed on top of file</span>
    <span class="n">readme</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;#&#39;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">,</span>
        <span class="s1">&#39;# This file contains extracted contacts half-matrix information&#39;</span><span class="p">,</span>
        <span class="s1">&#39;#&#39;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">,</span>
        <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="k">for</span> <span class="n">head</span> <span class="ow">in</span> <span class="n">header</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">readme</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;# </span><span class="si">{</span><span class="n">head</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">dttype_info</span><span class="p">[</span><span class="n">head</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Write file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tsvout</span><span class="p">:</span>
        <span class="n">tsvout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">readme</span><span class="p">))</span>
        <span class="n">tsvout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tsv_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">path</span></div>


<div class="viewcode-block" id="tsv_to_heatmap"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.tsv_to_heatmap">[docs]</a><span class="k">def</span> <span class="nf">tsv_to_heatmap</span><span class="p">(</span>
        <span class="n">tsv_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">data_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ca-ca-dist&#39;</span><span class="p">,</span>
        <span class="n">contact_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">7.5</span><span class="p">,</span>
        <span class="n">colorscale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Greys&#39;</span><span class="p">,</span>
        <span class="n">output_fname</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;contacts.html&#39;</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read a tsv file and generate a heatmap from it.</span>

<span class="sd">    Paramters</span>
<span class="sd">    ---------</span>
<span class="sd">    tsv_path : Path</span>
<span class="sd">        Path a the .tsv file containing contact data.</span>
<span class="sd">    sep : str</span>
<span class="sd">        Separator character used to split data in each line.</span>
<span class="sd">    data_key : str</span>
<span class="sd">        Data key used to draw the plot.</span>
<span class="sd">    contact_threshold : float</span>
<span class="sd">        Upper boundary of maximum value to be plotted.</span>
<span class="sd">         any value above it will be set to this value.</span>
<span class="sd">    output_fname : Path</span>
<span class="sd">        Path to the generated graph.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">half_matrix</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">header</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tsv_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># skip commented lines</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c1"># split line</span>
            <span class="n">s_</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
            <span class="c1"># gather header</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">s_</span>
                <span class="k">continue</span>
            <span class="c1"># point labels</span>
            <span class="n">label1</span> <span class="o">=</span> <span class="n">s_</span><span class="p">[</span><span class="n">header</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;res1&#39;</span><span class="p">)]</span>
            <span class="n">label2</span> <span class="o">=</span> <span class="n">s_</span><span class="p">[</span><span class="n">header</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;res2&#39;</span><span class="p">)]</span>
            <span class="c1"># Add them to set of labels</span>
            <span class="k">if</span> <span class="n">label1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label2</span><span class="p">)</span>

            <span class="c1"># point data</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s_</span><span class="p">[</span><span class="n">header</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">data_key</span><span class="p">)])</span>
            <span class="c1"># bound data to contact_threshold</span>
            <span class="n">bounded_value</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">contact_threshold</span><span class="p">)</span>
            <span class="c1"># add it to matrix</span>
            <span class="n">half_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bounded_value</span><span class="p">)</span>

    <span class="c1"># Genereate full matrix</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">squareform</span><span class="p">(</span><span class="n">half_matrix</span><span class="p">)</span>

    <span class="c1"># set data label</span>
    <span class="n">color_scale</span> <span class="o">=</span> <span class="n">datakey_to_colorscale</span><span class="p">(</span><span class="n">data_key</span><span class="p">,</span> <span class="n">color_scale</span><span class="o">=</span><span class="n">colorscale</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;ratio&#39;</span> <span class="ow">in</span> <span class="n">data_key</span><span class="p">:</span>
        <span class="n">data_label</span> <span class="o">=</span> <span class="s1">&#39;ratio&#39;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_label</span> <span class="o">=</span> <span class="s1">&#39;distance&#39;</span>

    <span class="c1"># Generate heatmap</span>
    <span class="n">output_filepath</span> <span class="o">=</span> <span class="n">heatmap_plotly</span><span class="p">(</span>
        <span class="n">matrix</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">data_label</span><span class="p">},</span>
        <span class="n">xlabels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
        <span class="n">ylabels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
        <span class="n">color_scale</span><span class="o">=</span><span class="n">color_scale</span><span class="p">,</span>
        <span class="n">output_fname</span><span class="o">=</span><span class="n">output_fname</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">output_filepath</span></div>


<div class="viewcode-block" id="datakey_to_colorscale"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.datakey_to_colorscale">[docs]</a><span class="k">def</span> <span class="nf">datakey_to_colorscale</span><span class="p">(</span><span class="n">data_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">color_scale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Greys&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert color scale into reverse if data implies to do it.</span>

<span class="sd">    data_key : str</span>
<span class="sd">        A dictionary key pointing to data type.</span>
<span class="sd">    color_scale : str</span>
<span class="sd">        Name of a base plotpy color_scale.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    color_scale : str</span>
<span class="sd">        Possibly the reverse name of the color_scale.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">color_scale</span><span class="si">}</span><span class="s1">_r&#39;</span> <span class="k">if</span> <span class="s1">&#39;ratio&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_key</span> <span class="k">else</span> <span class="n">color_scale</span></div>


<span class="c1">#############</span>
<span class="c1"># Start of the chord chart functions</span>
<span class="c1">#############</span>
<div class="viewcode-block" id="moduloAB"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.moduloAB">[docs]</a><span class="k">def</span> <span class="nf">moduloAB</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lb</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ub</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Map a real number onto the unit circle.</span>

<span class="sd">     The unit circle is identified with the interval [lb, ub), ub-lb=2*PI.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    val : float</span>
<span class="sd">        The value to be mapped into the unit circle.</span>
<span class="sd">    lb : float</span>
<span class="sd">        The lower boundary.</span>
<span class="sd">    ub : float</span>
<span class="sd">        The upper boundary</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    moduloab : float</span>
<span class="sd">        The modulo of val between lb and ub</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lb</span> <span class="o">&gt;=</span> <span class="n">ub</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Incorrect interval ends&#39;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="n">lb</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">ub</span> <span class="o">-</span> <span class="n">lb</span><span class="p">)</span>
    <span class="n">moduloab</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">ub</span> <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">y</span> <span class="o">+</span> <span class="n">lb</span>
    <span class="k">return</span> <span class="n">moduloab</span></div>


<div class="viewcode-block" id="within_2PI"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.within_2PI">[docs]</a><span class="k">def</span> <span class="nf">within_2PI</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if float value is within unit circle value range.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    val : float</span>
<span class="sd">        The value to be tested.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PI</span></div>


<div class="viewcode-block" id="check_square_matrix"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.check_square_matrix">[docs]</a><span class="k">def</span> <span class="nf">check_square_matrix</span><span class="p">(</span><span class="n">data_matrix</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the matrix is a square one.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_matrix : NDArray (2DArray)</span>
<span class="sd">        The matrix to be checked.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    nb_rows : int</span>
<span class="sd">        Number of rows in this matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">matrixshape</span> <span class="o">=</span> <span class="n">data_matrix</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nb_rows</span> <span class="o">=</span> <span class="n">matrixshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matrixshape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Data array must have only two dimensions&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nb_rows</span> <span class="o">!=</span> <span class="n">matrixshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Data array must have (n,n) shape&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nb_rows</span></div>


<div class="viewcode-block" id="get_ideogram_ends"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.get_ideogram_ends">[docs]</a><span class="k">def</span> <span class="nf">get_ideogram_ends</span><span class="p">(</span><span class="n">ideogram_len</span><span class="p">:</span> <span class="n">NDFloat</span><span class="p">,</span> <span class="n">gap</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate ideogram ends.</span>

<span class="sd">    Paramaters</span>
<span class="sd">    ----------</span>
<span class="sd">    ideogram_len : NDArray</span>
<span class="sd">        Length of each ideograms.</span>
<span class="sd">    gap : float</span>
<span class="sd">        Gap to add in between each ideogram.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    ideo_ends : list[tuple[float]]</span>
<span class="sd">        List of start and end position for each ideograms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ideo_ends</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ideogram_len</span><span class="p">)):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">ideogram_len</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">ideo_ends</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
        <span class="c1"># Increment new start by gap for next origin</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">+</span> <span class="n">gap</span>
    <span class="k">return</span> <span class="n">ideo_ends</span></div>


<div class="viewcode-block" id="make_ideogram_arc"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.make_ideogram_arc">[docs]</a><span class="k">def</span> <span class="nf">make_ideogram_arc</span><span class="p">(</span>
        <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">_phi</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">nb_points</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDFloat</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate ideogran arc.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    radius : float</span>
<span class="sd">        The circle radius.</span>
<span class="sd">    phi : tuple[float, float]</span>
<span class="sd">        Tuple of ends angle coordinates of an arc.</span>
<span class="sd">    nb_points : float</span>
<span class="sd">        Parameter that controls the number of points to be evaluated on an arc</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    arc_positions : NDArray</span>
<span class="sd">        Array of 2D coorinates defining an arc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">within_2PI</span><span class="p">(</span><span class="n">_phi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">within_2PI</span><span class="p">(</span><span class="n">_phi</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="p">[</span><span class="n">moduloAB</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PI</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">_phi</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">_phi</span><span class="p">]</span>
    <span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">PI</span><span class="p">)</span>
    <span class="n">nr</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">PI</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="k">else</span> <span class="nb">int</span><span class="p">((</span><span class="n">nb_points</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span> <span class="o">/</span> <span class="n">PI</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="n">moduloAB</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">PI</span><span class="p">,</span> <span class="n">PI</span><span class="p">),</span>
            <span class="n">moduloAB</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">PI</span><span class="p">,</span> <span class="n">PI</span><span class="p">),</span>
            <span class="n">nr</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">arc_positions</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">theta</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">arc_positions</span></div>


<div class="viewcode-block" id="make_ribbon_ends"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.make_ribbon_ends">[docs]</a><span class="k">def</span> <span class="nf">make_ribbon_ends</span><span class="p">(</span>
        <span class="n">matrix</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span>
        <span class="n">row_sum</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">ideo_ends</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
        <span class="n">L</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate all connecting ribbons coordinates.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    matrix : NDArray</span>
<span class="sd">        The data matrix.</span>
<span class="sd">    row_sum : list[int]</span>
<span class="sd">        Number of connexions in each row.</span>
<span class="sd">    ideo_ends : list[tuple[float, float]]</span>
<span class="sd">        List of start and end position for each ideograms.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ribbon_boundary : list[list[tuple[float, float]]]</span>
<span class="sd">        Matrix of per residue ribbons start and end positions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ribbon_boundary</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ideo_end</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ideo_ends</span><span class="p">):</span>
        <span class="c1"># Point stating coordinates of this residue ideo</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ideo_end</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># No ribbon to be formed</span>
        <span class="k">if</span> <span class="n">row_sum</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Add empty set of ribbons</span>
            <span class="n">ribbon_boundary</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ideo_ends</span><span class="p">))])</span>
            <span class="k">continue</span>
        <span class="c1"># Initiate row ribbons</span>
        <span class="n">row_ribbon_ends</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Compute increment</span>
        <span class="n">increment</span> <span class="o">=</span> <span class="p">(</span><span class="n">ideo_end</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">row_sum</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="c1"># Loop over positions</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">L</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Skip if no ribbon to add for this k, j pair</span>
            <span class="k">if</span> <span class="n">matrix</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">row_ribbon_ends</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="c1"># Define end</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">increment</span><span class="p">)</span>
            <span class="c1"># Hold data</span>
            <span class="n">row_ribbon_ends</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
            <span class="c1"># Set next start to current end</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>
        <span class="c1"># Add full row</span>
        <span class="n">ribbon_boundary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_ribbon_ends</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ribbon_boundary</span></div>


<div class="viewcode-block" id="control_pts"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.control_pts">[docs]</a><span class="k">def</span> <span class="nf">control_pts</span><span class="p">(</span>
        <span class="n">angle</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate control points to draw a SVGpath.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    angle : list[float]</span>
<span class="sd">        A list containing angular coordinates of the control points b0, b1, b2.</span>
<span class="sd">    radius : float</span>
<span class="sd">        The distance from b1 to the origin O(0,0)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    control_points : list[tuple[float, float]]</span>
<span class="sd">        The set of control points.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Raised if the number of angular coordinates is not equal to 3.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check number of angular coordinates</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;angle must have len = 3&#39;</span><span class="p">)</span>
    <span class="n">b_cplx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">angle</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
    <span class="c1"># Give it its size</span>
    <span class="n">b_cplx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">b_cplx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># Generate control points as a list for two values</span>
    <span class="n">control_points</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">b_cplx</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">b_cplx</span><span class="o">.</span><span class="n">imag</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">control_points</span></div>


<div class="viewcode-block" id="ctrl_rib_chords"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.ctrl_rib_chords">[docs]</a><span class="k">def</span> <span class="nf">ctrl_rib_chords</span><span class="p">(</span>
        <span class="n">side1</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">side2</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate poligons points aiming at drawing ribbons.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    side1 : tuple[float, float]</span>
<span class="sd">        List of angular variables of the ribbon arc ends defining</span>
<span class="sd">         the ribbon starting (ending) arc</span>
<span class="sd">    side2 : tuple[float, float]</span>
<span class="sd">        List of angular variables of the ribbon arc ends defining</span>
<span class="sd">         the ribbon starting (ending) arc</span>
<span class="sd">    radius : float, optional</span>
<span class="sd">        Circle radius size</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list[list[tuple[float, float]]]</span>
<span class="sd">        _description_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">side1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">side2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;the arc ends must be elements in a list of len 2&#39;</span><span class="p">)</span>
    <span class="n">poligons</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">control_pts</span><span class="p">(</span>
            <span class="p">[</span><span class="n">side1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="p">(</span><span class="n">side1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">side2</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">side2</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span>
            <span class="n">radius</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="k">return</span> <span class="n">poligons</span></div>


<div class="viewcode-block" id="make_q_bezier"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.make_q_bezier">[docs]</a><span class="k">def</span> <span class="nf">make_q_bezier</span><span class="p">(</span><span class="n">control_points</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define the Plotly SVG path for a quadratic Bezier curve.</span>

<span class="sd">        defined by the list of its control points.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    control_points : list[tuple[float, float]]</span>
<span class="sd">        List of control points</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    svgpath : str</span>
<span class="sd">        An SVG path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">control_points</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;control poligon must have 3 points&#39;</span><span class="p">)</span>
    <span class="n">_a</span><span class="p">,</span> <span class="n">_b</span><span class="p">,</span> <span class="n">_c</span> <span class="o">=</span> <span class="n">control_points</span>
    <span class="n">svgpath</span> <span class="o">=</span> <span class="s1">&#39;M &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">_a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">_a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; Q &#39;</span> <span class="o">+</span>\
        <span class="nb">str</span><span class="p">(</span><span class="n">_b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">_b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>\
        <span class="nb">str</span><span class="p">(</span><span class="n">_c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">_c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">svgpath</span></div>


<div class="viewcode-block" id="make_ribbon_arc"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.make_ribbon_arc">[docs]</a><span class="k">def</span> <span class="nf">make_ribbon_arc</span><span class="p">(</span><span class="n">theta0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">theta1</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a SVGpath to draw a ribbon arc.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta0 : float</span>
<span class="sd">        Starting angle value</span>
<span class="sd">    theta1 : float</span>
<span class="sd">        Ending angle value</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    string_arc : str</span>
<span class="sd">        A string representing the SVGpath of the ribbon arc.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If provided theta0 and theta1 angles are incorrect for a ribbon.</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the angle coordinates for an arc side of a ribbon are not</span>
<span class="sd">         in the appropriate range [0, 2*pi]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">within_2PI</span><span class="p">(</span><span class="n">theta0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">within_2PI</span><span class="p">(</span><span class="n">theta1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">theta0</span> <span class="o">&lt;</span> <span class="n">theta1</span><span class="p">:</span>
            <span class="n">theta0</span> <span class="o">=</span> <span class="n">moduloAB</span><span class="p">(</span><span class="n">theta0</span><span class="p">,</span> <span class="o">-</span><span class="n">PI</span><span class="p">,</span> <span class="n">PI</span><span class="p">)</span>
            <span class="n">theta1</span> <span class="o">=</span> <span class="n">moduloAB</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="o">-</span><span class="n">PI</span><span class="p">,</span> <span class="n">PI</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">theta0</span> <span class="o">*</span> <span class="n">theta1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;incorrect angle coordinates for ribbon&#39;</span><span class="p">)</span>

        <span class="n">nr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">40</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta0</span> <span class="o">-</span> <span class="n">theta1</span><span class="p">)</span> <span class="o">/</span> <span class="n">PI</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nr</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">nr</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">theta0</span><span class="p">,</span> <span class="n">theta1</span><span class="p">,</span> <span class="n">nr</span><span class="p">)</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">theta</span><span class="p">)</span>  <span class="c1"># points on arc in polar complex form</span>

        <span class="n">string_arc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">)):</span>
            <span class="n">string_arc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;L </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">pts</span><span class="o">.</span><span class="n">real</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">pts</span><span class="o">.</span><span class="n">imag</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="si">}</span><span class="s1"> &#39;</span>
        <span class="k">return</span> <span class="n">string_arc</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;the angle coordinates for an arc side of a ribbon &#39;</span>
                         <span class="s1">&#39;must be in [0, 2*pi]&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_layout"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.make_layout">[docs]</a><span class="k">def</span> <span class="nf">make_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">plot_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">layout_shapes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate the chart layout.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    title : str</span>
<span class="sd">        Title to be given to the chart.</span>
<span class="sd">    plot_size : float</span>
<span class="sd">        Size of the chart.</span>
<span class="sd">    layout_shapes : list[dict]</span>
<span class="sd">        Shapes to be drawn.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    layout : go.Layout</span>
<span class="sd">        The plotly layout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set axis parameters to hide axis line, grid, ticklabels and title</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;showline&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;zeroline&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;showgrid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;showticklabels&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="c1"># Getenate the layout</span>
    <span class="n">layout</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="n">plot_size</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="n">plot_size</span><span class="p">,</span>
        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">25</span><span class="p">),</span>
        <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">,</span>
        <span class="n">shapes</span><span class="o">=</span><span class="n">layout_shapes</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">layout</span></div>


<div class="viewcode-block" id="make_ideo_shape"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.make_ideo_shape">[docs]</a><span class="k">def</span> <span class="nf">make_ideo_shape</span><span class="p">(</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">line_color</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">fill_color</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate data to draw a ideogram shape.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        A SVGPath to be drawn.</span>
<span class="sd">    line_color : str</span>
<span class="sd">        Color of the shape boundary.</span>
<span class="sd">    fill_color : str</span>
<span class="sd">        Shape filling color fr the ribbon shape.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Data enabling to draw a ideogram shape in layout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;line&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">line_color</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mf">0.45</span><span class="p">},</span>
        <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span>
        <span class="s2">&quot;fillcolor&quot;</span><span class="p">:</span> <span class="n">fill_color</span><span class="p">,</span>
        <span class="s2">&quot;layer&quot;</span><span class="p">:</span> <span class="s1">&#39;below&#39;</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="make_ribbon"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.make_ribbon">[docs]</a><span class="k">def</span> <span class="nf">make_ribbon</span><span class="p">(</span>
        <span class="n">side1</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">side2</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">line_color</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">fill_color</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate data to draw a ribbon.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    side1 : list[float]</span>
<span class="sd">        List of angular variables of first ribbon arc ends defining</span>
<span class="sd">         the ribbon starting (ending) arc.</span>
<span class="sd">    side2 : list[float]</span>
<span class="sd">        List of angular variables of the other ribbon arc ends defining</span>
<span class="sd">         the ribbon starting (ending) arc.</span>
<span class="sd">    line_color : str</span>
<span class="sd">        Color of the shape boundary.</span>
<span class="sd">    fill_color : str</span>
<span class="sd">        Shape filling color fr the ribbon shape.</span>
<span class="sd">    radius : float, optional</span>
<span class="sd">        Circle radius size, by default 0.2.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Data enabling to draw a ribbon in layout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">poligon</span> <span class="o">=</span> <span class="n">ctrl_rib_chords</span><span class="p">(</span><span class="n">side1</span><span class="p">,</span> <span class="n">side2</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
    <span class="n">_b</span><span class="p">,</span> <span class="n">_c</span> <span class="o">=</span> <span class="n">poligon</span>
    <span class="c1"># Generate the SVGpath</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">make_q_bezier</span><span class="p">(</span><span class="n">_b</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">+=</span> <span class="n">make_ribbon_arc</span><span class="p">(</span><span class="n">side2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">side2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">path</span> <span class="o">+=</span> <span class="n">make_q_bezier</span><span class="p">(</span><span class="n">_c</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">path</span> <span class="o">+=</span> <span class="n">make_ribbon_arc</span><span class="p">(</span><span class="n">side1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">side1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">line_color</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
        <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fillcolor&#39;</span><span class="p">:</span> <span class="n">fill_color</span><span class="p">,</span>
        <span class="s1">&#39;layer&#39;</span><span class="p">:</span> <span class="s1">&#39;below&#39;</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="invPerm"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.invPerm">[docs]</a><span class="k">def</span> <span class="nf">invPerm</span><span class="p">(</span><span class="n">perm</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate the inverse of a permutation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    perm : _type_</span>
<span class="sd">        A permutation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    inv : list[int]</span>
<span class="sd">        Inverse of a permutation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Fill with zeros</span>
    <span class="n">inv</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">perm</span><span class="p">):</span>
        <span class="n">inv</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
    <span class="k">return</span> <span class="n">inv</span></div>


<div class="viewcode-block" id="get_chains_ideograms_ends"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.get_chains_ideograms_ends">[docs]</a><span class="k">def</span> <span class="nf">get_chains_ideograms_ends</span><span class="p">(</span>
        <span class="n">chains</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">gap</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PI</span> <span class="o">*</span> <span class="mf">0.005</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n">NDFloat</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build ideogram ends to represent protein chains.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    chains : dict[str, list[str]]</span>
<span class="sd">        Dictionary mapping chains with their respective set of residues labels.</span>
<span class="sd">    gap : float, optional</span>
<span class="sd">        Gap between two ideograms, by default 2*PI*0.005</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    chain_ideo_ends : list[tuple[float, float]]</span>
<span class="sd">        Ideogram ends to represent protein chains.</span>
<span class="sd">    chain_ideogram_length : NDFloat</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chain_row_sum</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">chains</span><span class="p">[</span><span class="n">chain</span><span class="p">])</span>
                     <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">chains</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
    <span class="n">chain_ideogram_length</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PI</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">chain_row_sum</span><span class="p">)</span>
    <span class="n">chain_ideogram_length</span> <span class="o">/=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">chain_row_sum</span><span class="p">)</span>
    <span class="n">chain_ideogram_length</span> <span class="o">-=</span> <span class="n">gap</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chain_row_sum</span><span class="p">))</span>
    <span class="n">chain_ideo_ends</span> <span class="o">=</span> <span class="n">get_ideogram_ends</span><span class="p">(</span><span class="n">chain_ideogram_length</span><span class="p">,</span> <span class="n">gap</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chain_ideo_ends</span><span class="p">,</span> <span class="n">chain_ideogram_length</span></div>


<div class="viewcode-block" id="get_all_ideograms_ends"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.get_all_ideograms_ends">[docs]</a><span class="k">def</span> <span class="nf">get_all_ideograms_ends</span><span class="p">(</span>
        <span class="n">chains</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">gap</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PI</span> <span class="o">*</span> <span class="mf">0.005</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate both chain and residues ideograms ends.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    chains : dict</span>
<span class="sd">        Dictionary mapping to list of residues labels.</span>
<span class="sd">    gap : float, optional</span>
<span class="sd">        Gap distance used to separate two ideograms, by default 2*PI*0.005</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[ideo_ends, chain_ideo_ends]</span>
<span class="sd">        A tuple containing residues ideo ends and chains ideo ends.</span>

<span class="sd">    ideo_ends : list[tuple[float, float]]</span>
<span class="sd">        List of residues ideograms start and ending positions.</span>
<span class="sd">    chain_ideo_ends : list[tuple[float, float]]</span>
<span class="sd">        List of chain ideograms start and ending positions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chain_ideo_ends</span><span class="p">,</span> <span class="n">chain_ideogram_length</span> <span class="o">=</span> <span class="n">get_chains_ideograms_ends</span><span class="p">(</span>
        <span class="n">chains</span><span class="p">,</span>
        <span class="n">gap</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">ideo_ends</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">chain</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">chains</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
        <span class="n">chain_labels</span> <span class="o">=</span> <span class="n">chains</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">_label</span> <span class="ow">in</span> <span class="n">chain_labels</span><span class="p">:</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="p">(</span><span class="n">chain_ideogram_length</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain_labels</span><span class="p">))</span>
            <span class="n">ideo_ends</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">))</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">right</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">right</span> <span class="o">+</span> <span class="n">gap</span>
    <span class="k">return</span> <span class="n">ideo_ends</span><span class="p">,</span> <span class="n">chain_ideo_ends</span></div>


<div class="viewcode-block" id="split_labels_by_chains"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.split_labels_by_chains">[docs]</a><span class="k">def</span> <span class="nf">split_labels_by_chains</span><span class="p">(</span><span class="n">labels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Map each label to its chain.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    labels : list[str]</span>
<span class="sd">        List of residues keys. e.g.: A-SER-123 (chain A, serine 123)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    chains : dict[str, list[str]]</span>
<span class="sd">        Dictionary mapping chains with their respective set of residues labels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chains</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">lab</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">chain</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">resid</span> <span class="o">=</span> <span class="n">lab</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">chain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">chains</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">chains</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">chains</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chains</span></div>


<div class="viewcode-block" id="contacts_to_connect_matrix"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.contacts_to_connect_matrix">[docs]</a><span class="k">def</span> <span class="nf">contacts_to_connect_matrix</span><span class="p">(</span>
        <span class="n">matrix</span><span class="p">:</span> <span class="n">NDFloat</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    matrix : NDFloat</span>
<span class="sd">        A square contact matrix.</span>
<span class="sd">    labels : list[str]</span>
<span class="sd">        List of labels corresponding row &amp; columns entries.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    connect_matrix : list[list[Union[str, int]]]</span>
<span class="sd">        The connectivity matrix without self contacts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">connect_matrix</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ri</span><span class="p">,</span> <span class="n">label_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="c1"># Point label chain name</span>
        <span class="n">chain1</span> <span class="o">=</span> <span class="n">label_i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">new_contact_mat_row</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Loop over columns</span>
        <span class="k">for</span> <span class="n">ci</span><span class="p">,</span> <span class="n">label_j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
            <span class="c1"># Point label chain name</span>
            <span class="n">chain2</span> <span class="o">=</span> <span class="n">label_j</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">chain1</span> <span class="o">!=</span> <span class="n">chain2</span> <span class="ow">and</span> <span class="n">matrix</span><span class="p">[</span><span class="n">ri</span><span class="p">,</span> <span class="n">ci</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">interaction</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">interaction</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">new_contact_mat_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interaction</span><span class="p">)</span>
        <span class="c1"># Hold row</span>
        <span class="n">connect_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_contact_mat_row</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">connect_matrix</span></div>


<div class="viewcode-block" id="to_nice_label"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.to_nice_label">[docs]</a><span class="k">def</span> <span class="nf">to_nice_label</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a label into a user friendly label.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    label : str</span>
<span class="sd">        Label name as found in csv</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nicelabel : str</span>
<span class="sd">        User friendly description of the label.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">slabel</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">nicelabel</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Chain </span><span class="si">{</span><span class="n">slabel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, residue </span><span class="si">{</span><span class="n">slabel</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">slabel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">nicelabel</span></div>


<div class="viewcode-block" id="to_color_weight"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.to_color_weight">[docs]</a><span class="k">def</span> <span class="nf">to_color_weight</span><span class="p">(</span>
        <span class="n">distance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">max_dist</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">min_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.</span><span class="p">,</span>
        <span class="n">min_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">max_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.90</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute color weight based on distance.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    distance : float</span>
<span class="sd">        The distance to weight.</span>
<span class="sd">    max_dist : float</span>
<span class="sd">        The max distance observed in the dataset.</span>
<span class="sd">    min_dist : float, optional</span>
<span class="sd">        The minumu, distance observed in the dataset, by default 2.</span>
<span class="sd">    min_weight : float, optional</span>
<span class="sd">        Color wight for the maximum distance, by default 0.2</span>
<span class="sd">    max_weight : float, optional</span>
<span class="sd">        Color wight for the minimum distance, by default 0.90</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    weight : float</span>
<span class="sd">        The color weight. in range [min_weight, max_weight]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Scale dist into minimum</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">min_dist</span><span class="p">)</span>
    <span class="c1"># Compute ratio</span>
    <span class="n">ratio_dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist</span> <span class="o">-</span> <span class="n">min_dist</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_dist</span> <span class="o">-</span> <span class="n">min_dist</span><span class="p">)</span>
    <span class="c1"># Obtain corresponding weight</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="p">((</span><span class="n">min_weight</span> <span class="o">-</span> <span class="n">max_weight</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio_dist</span><span class="p">)</span> <span class="o">+</span> <span class="n">max_weight</span>
    <span class="c1"># Return rounded value of weight</span>
    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="to_rgba_color_string"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.to_rgba_color_string">[docs]</a><span class="k">def</span> <span class="nf">to_rgba_color_string</span><span class="p">(</span>
        <span class="n">connect_color</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a rgba string from list of colors and alpha.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    connect_color : list[int]</span>
<span class="sd">        A 3-values list of integers defining the red, green and blue colors.</span>
<span class="sd">    alpha : float</span>
<span class="sd">        color_weight</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The html like rgba colors. e.g.: &#39;rgba(123, 123, 123, 0.5)&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">colors_str</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">connect_color</span><span class="p">])</span>
    <span class="n">rgba_color</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;rgba(</span><span class="si">{</span><span class="n">colors_str</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s1">)&#39;</span>
    <span class="k">return</span> <span class="n">rgba_color</span></div>


<div class="viewcode-block" id="to_full_matrix"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.to_full_matrix">[docs]</a><span class="k">def</span> <span class="nf">to_full_matrix</span><span class="p">(</span>
        <span class="n">half_matrix</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
        <span class="n">diag_val</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a full matrix from a half matrix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    half_matrix : list[Any]</span>
<span class="sd">        Values of the N*(N-1)/2 half matrix.</span>
<span class="sd">    diag_val : Any</span>
<span class="sd">        Value to be placed in diagonal of the full matrix.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matrix : NDArry</span>
<span class="sd">        The reconstituted full matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Genereate full matrix from N*(N-1)/2 vector</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">squareform</span><span class="p">(</span><span class="n">half_matrix</span><span class="p">)</span>
    <span class="c1"># Update diagonal with data</span>
    <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">diag_val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">matrix</span></div>


<div class="viewcode-block" id="make_chordchart"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.make_chordchart">[docs]</a><span class="k">def</span> <span class="nf">make_chordchart</span><span class="p">(</span>
        <span class="n">_contact_matrix</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
        <span class="n">_dist_matrix</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
        <span class="n">_interttype_matrix</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">_labels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">gap</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">PI</span> <span class="o">*</span> <span class="mf">0.005</span><span class="p">,</span>
        <span class="n">output_fpath</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;chordchart.html&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Chord diagram&#39;</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a plotly chordchart graph.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    _contact_matrix : list[list[int]]</span>
<span class="sd">        The contact matrix</span>
<span class="sd">    _dist_matrix : list[list[float]]</span>
<span class="sd">        The distance matrix</span>
<span class="sd">    _interttype_matrix : list[list[str]]</span>
<span class="sd">        The interaction type matrix</span>
<span class="sd">    _labels : list[str]</span>
<span class="sd">        Labels of each matrix rows (and columns as supposed to be symetric)</span>
<span class="sd">    gap : float, optional</span>
<span class="sd">        Gap between two ideograms, by default 2*PI*0.005</span>
<span class="sd">    output_fpath : Union[str, Path], optional</span>
<span class="sd">        Path to the output file, by default &#39;chordchart.html&#39;</span>
<span class="sd">    title : str, optional</span>
<span class="sd">        Title to give to the diagram, by default &#39;Chord diagram&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    output_fpath : Union[str, Path]</span>
<span class="sd">        Path to the genereated output file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Unpack matrices</span>
    <span class="n">contact_matrix</span> <span class="o">=</span> <span class="n">contacts_to_connect_matrix</span><span class="p">(</span><span class="n">_contact_matrix</span><span class="p">,</span> <span class="n">_labels</span><span class="p">)</span>

    <span class="c1"># Reverse data order so later graph displayed clockwise</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ri</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">contact_matrix</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">dist_matrix</span> <span class="o">=</span> <span class="p">[</span><span class="n">ri</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">_dist_matrix</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">interttype_matrix</span> <span class="o">=</span> <span class="p">[</span><span class="n">ri</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">_interttype_matrix</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">_labels</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Check matrix shape</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">check_square_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>

    <span class="c1"># Map labels into respective chains</span>
    <span class="n">chains</span> <span class="o">=</span> <span class="n">split_labels_by_chains</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="c1"># Set matrix of indices</span>
    <span class="n">idx_sort</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="p">)]</span>

    <span class="c1"># Compute residues and chain ideograms positions</span>
    <span class="n">ideo_ends</span><span class="p">,</span> <span class="n">chain_ideo_ends</span> <span class="o">=</span> <span class="n">get_all_ideograms_ends</span><span class="p">(</span><span class="n">chains</span><span class="p">,</span> <span class="n">gap</span><span class="o">=</span><span class="n">gap</span><span class="p">)</span>

    <span class="c1"># Compute number of connexion per residues</span>
    <span class="n">row_sum</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">L</span><span class="p">)]</span>

    <span class="c1"># Compute connexion ribbons positions</span>
    <span class="n">ribbon_ends</span> <span class="o">=</span> <span class="n">make_ribbon_ends</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">row_sum</span><span class="p">,</span> <span class="n">ideo_ends</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>

    <span class="c1"># Initiate shape holder</span>
    <span class="n">layout_shapes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Initiate ribbon info holder</span>
    <span class="n">ribbon_info</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Loop over entries</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">label1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>

        <span class="n">sigma</span> <span class="o">=</span> <span class="n">idx_sort</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">sigma_inv</span> <span class="o">=</span> <span class="n">invPerm</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
        <span class="c1"># Half matrix loop to avoid duplicates</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
            <span class="c1"># No data to draw</span>
            <span class="k">if</span> <span class="n">matrix</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">matrix</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Obtain ribbon color for this interaction type</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">connect_color</span> <span class="o">=</span> <span class="n">CONNECT_COLORS</span><span class="p">[</span><span class="n">interttype_matrix</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">connect_color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">123</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">123</span><span class="p">)</span>
            <span class="n">color_weith</span> <span class="o">=</span> <span class="n">to_color_weight</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mf">9.5</span><span class="p">)</span>
            <span class="n">rgba_color</span> <span class="o">=</span> <span class="n">to_rgba_color_string</span><span class="p">(</span><span class="n">connect_color</span><span class="p">,</span> <span class="n">color_weith</span><span class="p">)</span>

            <span class="c1"># Point ribbons data</span>
            <span class="n">side1</span> <span class="o">=</span> <span class="n">ribbon_ends</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">sigma_inv</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
            <span class="n">eta</span> <span class="o">=</span> <span class="n">idx_sort</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">eta_inv</span> <span class="o">=</span> <span class="n">invPerm</span><span class="p">(</span><span class="n">eta</span><span class="p">)</span>
            <span class="n">side2</span> <span class="o">=</span> <span class="n">ribbon_ends</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">eta_inv</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
            <span class="n">zi</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">side1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">side1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">zf</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">side2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">side2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

            <span class="c1"># reverse interaction type for second label</span>
            <span class="n">s_intertype</span> <span class="o">=</span> <span class="n">interttype_matrix</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="n">rev_s_intertype</span> <span class="o">=</span> <span class="n">s_intertype</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">rev_interttype</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rev_s_intertype</span><span class="p">)</span>
            <span class="c1"># Obtain nice labels</span>
            <span class="n">nicelabel1</span> <span class="o">=</span> <span class="n">to_nice_label</span><span class="p">(</span><span class="n">label1</span><span class="p">)</span>
            <span class="n">nicelabel2</span> <span class="o">=</span> <span class="n">to_nice_label</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="c1"># texti and textf are the strings that will be displayed when</span>
            <span class="c1"># hovering the mouse over the two ribbon ends</span>
            <span class="n">texti</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nicelabel1</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">rev_interttype</span><span class="si">}</span><span class="s1"> with </span><span class="si">{</span><span class="n">nicelabel2</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">textf</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nicelabel2</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">interttype_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s1"> with </span><span class="si">{</span><span class="n">nicelabel1</span><span class="si">}</span><span class="s1">&#39;</span>  <span class="c1"># noqa : E501</span>
            <span class="c1"># Generate interactive labels</span>
            <span class="k">for</span> <span class="n">zv</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">zi</span><span class="p">,</span> <span class="n">zf</span><span class="p">],</span> <span class="p">[</span><span class="n">texti</span><span class="p">,</span> <span class="n">textf</span><span class="p">]):</span>
                <span class="c1"># Generate ribbon info</span>
                <span class="n">ribbon_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">zv</span><span class="o">.</span><span class="n">real</span><span class="p">],</span>
                        <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">zv</span><span class="o">.</span><span class="n">imag</span><span class="p">],</span>
                        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
                        <span class="n">marker</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">rgba_color</span><span class="p">},</span>
                        <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
                        <span class="n">hoverinfo</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
            <span class="c1"># Note: must reverse these arc ends to avoid twisted ribbon</span>
            <span class="n">side2_rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">side2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">side2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># Append the ribbon shape</span>
            <span class="n">layout_shapes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">make_ribbon</span><span class="p">(</span>
                    <span class="n">side1</span><span class="p">,</span>
                    <span class="n">side2_rev</span><span class="p">,</span>
                    <span class="s1">&#39;rgba(175,175,175)&#39;</span><span class="p">,</span>
                    <span class="n">rgba_color</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

    <span class="n">ideograms</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Draw ideograms for residues</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">make_ideogram_arc</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">ideo_ends</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">zi</span> <span class="o">=</span> <span class="n">make_ideogram_arc</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ideo_ends</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="c1"># Point residue name</span>
        <span class="n">resname</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Point corresponding color</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rescolor</span> <span class="o">=</span> <span class="n">RESIDUES_COLORS</span><span class="p">[</span><span class="n">resname</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">rescolor</span> <span class="o">=</span> <span class="s1">&#39;rgba(123, 123, 123, 0.7)&#39;</span>

        <span class="c1"># Build textual info</span>
        <span class="n">text_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">to_nice_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="si">}</span><span class="s1">&lt;br&gt;&#39;</span>
        <span class="k">if</span> <span class="n">row_sum</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">text_info</span> <span class="o">+=</span> <span class="s1">&#39;No interaction&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text_info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;Total of </span><span class="si">{</span><span class="n">row_sum</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1"> interaction&#39;</span>
            <span class="k">if</span> <span class="n">row_sum</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">text_info</span> <span class="o">+=</span> <span class="s1">&#39;s&#39;</span>
        <span class="c1"># Add info</span>
        <span class="n">ideograms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">real</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">rescolor</span><span class="p">,</span>
                    <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="s1">&#39;spline&#39;</span><span class="p">,</span>
                    <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="n">text</span><span class="o">=</span><span class="n">text_info</span><span class="p">,</span>
                <span class="n">hoverinfo</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Build corresponding SVG path</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">svgpath</span> <span class="o">=</span> <span class="s1">&#39;M &#39;</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="n">svgpath</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">real</span><span class="p">[</span><span class="n">s</span><span class="p">])</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">imag</span><span class="p">[</span><span class="n">s</span><span class="p">])</span><span class="si">}</span><span class="s1"> L &#39;</span>

        <span class="n">Zi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zi</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="n">svgpath</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">Zi</span><span class="o">.</span><span class="n">real</span><span class="p">[</span><span class="n">s</span><span class="p">])</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">Zi</span><span class="o">.</span><span class="n">imag</span><span class="p">[</span><span class="n">s</span><span class="p">])</span><span class="si">}</span><span class="s1"> L &#39;</span>
        <span class="n">svgpath</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">real</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">imag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="c1"># Hold it</span>
        <span class="n">layout_shapes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">make_ideo_shape</span><span class="p">(</span>
                <span class="n">svgpath</span><span class="p">,</span>
                <span class="s1">&#39;rgba(150,150,150)&#39;</span><span class="p">,</span>
                <span class="n">rescolor</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="c1"># Draw ideograms for chains</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">chainid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">chains</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">make_ideogram_arc</span><span class="p">(</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">chain_ideo_ends</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">zi</span> <span class="o">=</span> <span class="n">make_ideogram_arc</span><span class="p">(</span><span class="mf">1.11</span><span class="p">,</span> <span class="n">chain_ideo_ends</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">ideograms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">real</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">CHAIN_COLORS</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                    <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="s1">&#39;spline&#39;</span><span class="p">,</span>
                    <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Chain </span><span class="si">{</span><span class="n">chainid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">hoverinfo</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Build corresponding SVG path</span>
        <span class="n">svgpath</span> <span class="o">=</span> <span class="s1">&#39;M &#39;</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="n">svgpath</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">real</span><span class="p">[</span><span class="n">s</span><span class="p">])</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">imag</span><span class="p">[</span><span class="n">s</span><span class="p">])</span><span class="si">}</span><span class="s1"> L &#39;</span>
        <span class="n">Zi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zi</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="n">svgpath</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">Zi</span><span class="o">.</span><span class="n">real</span><span class="p">[</span><span class="n">s</span><span class="p">])</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">Zi</span><span class="o">.</span><span class="n">imag</span><span class="p">[</span><span class="n">s</span><span class="p">])</span><span class="si">}</span><span class="s1"> L &#39;</span>
        <span class="n">svgpath</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">real</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">imag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="n">layout_shapes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">make_ideo_shape</span><span class="p">(</span>
                <span class="n">svgpath</span><span class="p">,</span>
                <span class="s1">&#39;rgba(150,150,150)&#39;</span><span class="p">,</span>
                <span class="n">CHAIN_COLORS</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="c1"># Compute figure size</span>
    <span class="n">fig_size</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">L</span> <span class="o">*</span> <span class="n">L</span><span class="p">)</span>
    <span class="c1"># Create plotly layout</span>
    <span class="n">layout</span> <span class="o">=</span> <span class="n">make_layout</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fig_size</span><span class="p">,</span> <span class="n">layout_shapes</span><span class="p">)</span>
    <span class="c1"># combine all data info</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ideograms</span> <span class="o">+</span> <span class="n">ribbon_info</span>
    <span class="c1"># Generate the figure</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">)</span>
    <span class="c1"># Fine tune figure</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="c1"># Write it as html file</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">write_html</span><span class="p">(</span><span class="n">output_fpath</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_fpath</span></div>


<div class="viewcode-block" id="tsv_to_chordchart"><a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.contactmap.contmap.html#haddock.modules.analysis.contactmap.contmap.tsv_to_chordchart">[docs]</a><span class="k">def</span> <span class="nf">tsv_to_chordchart</span><span class="p">(</span>
        <span class="n">tsv_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">data_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ca-ca-dist&#39;</span><span class="p">,</span>
        <span class="n">contact_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">7.5</span><span class="p">,</span>
        <span class="n">filter_intermolecular_contacts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">output_fname</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;contacts_chordchart.html&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Chord diagram&#39;</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read a tsv file and generate a chord diagram from it.</span>

<span class="sd">    Paramters</span>
<span class="sd">    ---------</span>
<span class="sd">    tsv_path : Path</span>
<span class="sd">        Path a the .tsv file containing contact data.</span>
<span class="sd">    sep : str</span>
<span class="sd">        Separator character used to split data in each line.</span>
<span class="sd">    data_key : str</span>
<span class="sd">        Data key used to draw the plot.</span>
<span class="sd">    contact_threshold : float</span>
<span class="sd">        Upper boundary of maximum value to be plotted.</span>
<span class="sd">         any value above it will be set to this value.</span>
<span class="sd">    output_fname : Union[Path, str]</span>
<span class="sd">        Path where to generate the graph.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    chord_chart_fpath : Union[Path, str]</span>
<span class="sd">        Path to the generated graph</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initiate holders</span>
    <span class="n">half_contact_matrix</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">half_value_matrix</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">half_intertype_matrix</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">header</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Read tsv file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tsv_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># skip commented lines</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c1"># split line</span>
            <span class="n">s_</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
            <span class="c1"># gather header</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">s_</span>
                <span class="k">continue</span>
            <span class="c1"># point labels</span>
            <span class="n">label1</span> <span class="o">=</span> <span class="n">s_</span><span class="p">[</span><span class="n">header</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;res1&#39;</span><span class="p">)]</span>
            <span class="n">label2</span> <span class="o">=</span> <span class="n">s_</span><span class="p">[</span><span class="n">header</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;res2&#39;</span><span class="p">)]</span>
            <span class="c1"># Add them to set of labels</span>
            <span class="k">if</span> <span class="n">label1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label2</span><span class="p">)</span>

            <span class="c1"># point data</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s_</span><span class="p">[</span><span class="n">header</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">data_key</span><span class="p">)])</span>
            <span class="c1"># check if in contact</span>
            <span class="n">contact</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="n">contact_threshold</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="c1"># Point interaction type</span>
            <span class="n">inter_type</span> <span class="o">=</span> <span class="n">s_</span><span class="p">[</span><span class="n">header</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;contact-type&#39;</span><span class="p">)]</span>
            <span class="c1"># add it to matrix</span>
            <span class="n">half_contact_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contact</span><span class="p">)</span>
            <span class="n">half_value_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">half_intertype_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inter_type</span><span class="p">)</span>

    <span class="c1"># Genereate full matrices</span>
    <span class="n">contact_matrix</span> <span class="o">=</span> <span class="n">to_full_matrix</span><span class="p">(</span><span class="n">half_contact_matrix</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">to_full_matrix</span><span class="p">(</span><span class="n">half_value_matrix</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">intertype_matrix</span> <span class="o">=</span> <span class="n">to_full_matrix</span><span class="p">(</span><span class="n">half_intertype_matrix</span><span class="p">,</span> <span class="s1">&#39;self-self&#39;</span><span class="p">)</span>

    <span class="c1"># Check if must get only the intermolecular contacts submatrix</span>
    <span class="k">if</span> <span class="n">filter_intermolecular_contacts</span><span class="p">:</span>
        <span class="c1"># Filter positions where: intermolecular contacts + dist &lt;= threshold</span>
        <span class="n">intmol_cont_labels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ri</span><span class="p">,</span> <span class="n">label1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
            <span class="n">label1_chain</span> <span class="o">=</span> <span class="n">label1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ci</span><span class="p">,</span> <span class="n">label2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                <span class="n">label2_chain</span> <span class="o">=</span> <span class="n">label2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Skip same chains</span>
                <span class="k">if</span> <span class="n">label1_chain</span> <span class="o">==</span> <span class="n">label2_chain</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># Check contacts</span>
                <span class="k">if</span> <span class="n">contact_matrix</span><span class="p">[</span><span class="n">ri</span><span class="p">,</span> <span class="n">ci</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">intmol_cont_labels</span> <span class="o">+=</span> <span class="p">[</span><span class="n">label1</span><span class="p">,</span> <span class="n">label2</span><span class="p">]</span>

        <span class="c1"># Obtain sorted subset</span>
        <span class="n">nodoubles_intmol_cont_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">intmol_cont_labels</span><span class="p">))</span>
        <span class="n">sorted_intmol_cont_labels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">nodoubles_intmol_cont_labels</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Get indices to be extracted</span>
        <span class="n">sorted_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sorted_intmol_cont_labels</span><span class="p">]</span>

        <span class="c1"># Get submatrix</span>
        <span class="n">contact_submatrix</span> <span class="o">=</span> <span class="n">extract_submatrix</span><span class="p">(</span><span class="n">contact_matrix</span><span class="p">,</span> <span class="n">sorted_indices</span><span class="p">)</span>
        <span class="n">dist_submatrix</span> <span class="o">=</span> <span class="n">extract_submatrix</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">,</span> <span class="n">sorted_indices</span><span class="p">)</span>
        <span class="n">intert_submatrix</span> <span class="o">=</span> <span class="n">extract_submatrix</span><span class="p">(</span><span class="n">intertype_matrix</span><span class="p">,</span> <span class="n">sorted_indices</span><span class="p">)</span>
        <span class="n">sublabels</span> <span class="o">=</span> <span class="n">sorted_intmol_cont_labels</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">contact_submatrix</span> <span class="o">=</span> <span class="n">contact_matrix</span>
        <span class="n">dist_submatrix</span> <span class="o">=</span> <span class="n">dist_matrix</span>
        <span class="n">intert_submatrix</span> <span class="o">=</span> <span class="n">intertype_matrix</span>
        <span class="n">sublabels</span> <span class="o">=</span> <span class="n">labels</span>

    <span class="c1"># Generate chord chart</span>
    <span class="n">chord_chart_fpath</span> <span class="o">=</span> <span class="n">make_chordchart</span><span class="p">(</span>
        <span class="n">contact_submatrix</span><span class="p">,</span>
        <span class="n">dist_submatrix</span><span class="p">,</span>
        <span class="n">intert_submatrix</span><span class="p">,</span>
        <span class="n">sublabels</span><span class="p">,</span>
        <span class="n">output_fpath</span><span class="o">=</span><span class="n">output_fname</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
        <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">chord_chart_fpath</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, BonvinLab.
      <span class="lastupdated">Last updated on Feb 23, 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>