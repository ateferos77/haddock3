

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>haddock.gear.prepare_run &mdash; haddock3 3.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d10597a4" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=acc74ff5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            haddock3
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">A brief introduction to HADDOCK3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../INSTALL.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../USAGE.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Workflow Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">Advanced features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../clients/haddock.clis.html">Command-line interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/index.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/index.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing to HADDOCK3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../citing.html">Citing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Library Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">haddock3</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../haddock.html">haddock</a></li>
      <li class="breadcrumb-item active">haddock.gear.prepare_run</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for haddock.gear.prepare_run</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Logic pertraining to preparing the run files and folders.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">difflib</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">it</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span><span class="p">,</span> <span class="n">suppress</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span><span class="p">,</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span><span class="p">,</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span><span class="p">,</span> <span class="n">PosixPath</span>

<span class="kn">from</span> <span class="nn">haddock</span> <span class="kn">import</span> <span class="n">EmptyPath</span><span class="p">,</span> <span class="n">contact_us</span><span class="p">,</span> <span class="n">haddock3_source_path</span><span class="p">,</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">haddock.core.defaults</span> <span class="kn">import</span> <span class="n">RUNDIR</span><span class="p">,</span> <span class="n">max_molecules_allowed</span>
<span class="kn">from</span> <span class="nn">haddock.core.exceptions</span> <span class="kn">import</span> <span class="n">ConfigurationError</span><span class="p">,</span> <span class="n">ModuleError</span>
<span class="kn">from</span> <span class="nn">haddock.core.typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">FilePath</span><span class="p">,</span>
    <span class="n">Generator</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">ParamDict</span><span class="p">,</span>
    <span class="n">ParamMap</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">haddock.gear.clean_steps</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">UNPACK_FOLDERS</span><span class="p">,</span>
    <span class="n">unpack_compressed_and_archived_files</span><span class="p">,</span>
    <span class="n">update_unpacked_names</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">haddock.gear.config</span> <span class="kn">import</span> <span class="n">get_module_name</span>
<span class="kn">from</span> <span class="nn">haddock.gear.config</span> <span class="kn">import</span> <span class="n">load</span> <span class="k">as</span> <span class="n">read_config</span>
<span class="kn">from</span> <span class="nn">haddock.gear.config</span> <span class="kn">import</span> <span class="n">save</span> <span class="k">as</span> <span class="n">save_config</span>
<span class="kn">from</span> <span class="nn">haddock.gear.expandable_parameters</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_mol_parameters</span><span class="p">,</span>
    <span class="n">get_multiple_index_groups</span><span class="p">,</span>
    <span class="n">get_single_index_groups</span><span class="p">,</span>
    <span class="n">is_mol_parameter</span><span class="p">,</span>
    <span class="n">read_mol_parameters</span><span class="p">,</span>
    <span class="n">read_multiple_idx_groups_user_config</span><span class="p">,</span>
    <span class="n">read_simplest_expandable</span><span class="p">,</span>
    <span class="n">read_single_idx_groups_user_config</span><span class="p">,</span>
    <span class="n">remove_trail_idx</span><span class="p">,</span>
    <span class="n">type_simplest_ep</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">haddock.gear.extend_run</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">read_num_molecules_from_folder</span><span class="p">,</span>
    <span class="n">renum_step_folders</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">haddock.gear.greetings</span> <span class="kn">import</span> <span class="n">get_goodbye_help</span>
<span class="kn">from</span> <span class="nn">haddock.gear.parameters</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">config_mandatory_general_parameters</span><span class="p">,</span>
    <span class="n">config_optional_general_parameters</span><span class="p">,</span>
    <span class="n">config_optional_general_parameters_dict</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">haddock.gear.preprocessing</span> <span class="kn">import</span> <span class="n">process_pdbs</span><span class="p">,</span> <span class="n">read_additional_residues</span>
<span class="kn">from</span> <span class="nn">haddock.gear.restart_run</span> <span class="kn">import</span> <span class="n">remove_folders_after_number</span>
<span class="kn">from</span> <span class="nn">haddock.gear.validations</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">v_rundir</span><span class="p">,</span>
    <span class="n">validate_defaults_yaml</span><span class="p">,</span>
    <span class="p">)</span>
<span class="kn">from</span> <span class="nn">haddock.gear.yaml2cfg</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">read_from_yaml_config</span><span class="p">,</span>
    <span class="n">find_incompatible_parameters</span><span class="p">,</span>
    <span class="p">)</span>
<span class="kn">from</span> <span class="nn">haddock.gear.zerofill</span> <span class="kn">import</span> <span class="n">zero_fill</span>
<span class="kn">from</span> <span class="nn">haddock.libs.libfunc</span> <span class="kn">import</span> <span class="n">not_none</span>
<span class="kn">from</span> <span class="nn">haddock.libs.libio</span> <span class="kn">import</span> <span class="n">make_writeable_recursive</span>
<span class="kn">from</span> <span class="nn">haddock.libs.libutil</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">extract_keys_recursive</span><span class="p">,</span>
    <span class="n">recursive_convert_paths_to_strings</span><span class="p">,</span>
    <span class="n">recursive_dict_update</span><span class="p">,</span>
    <span class="n">remove_dict_keys</span><span class="p">,</span>
    <span class="n">transform_to_list</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">haddock.modules</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_module_steps_folders</span><span class="p">,</span>
    <span class="n">modules_category</span><span class="p">,</span>
    <span class="n">modules_names</span><span class="p">,</span>
    <span class="n">non_mandatory_general_parameters_defaults</span><span class="p">,</span>
    <span class="n">incompatible_defaults_params</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">haddock.modules.analysis</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">confirm_resdic_chainid_length</span><span class="p">,</span>
    <span class="n">modules_using_resdic</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">ALL_POSSIBLE_GENERAL_PARAMETERS</span> <span class="o">=</span> <span class="nb">set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
    <span class="nb">set</span><span class="p">(</span><span class="n">config_mandatory_general_parameters</span><span class="p">),</span>
    <span class="nb">set</span><span class="p">(</span><span class="n">non_mandatory_general_parameters_defaults</span><span class="p">),</span>
    <span class="n">config_optional_general_parameters</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Dict mapping string types (in default.yaml) into python3 objects types</span>
<span class="n">TYPES_MAPPER</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;boolean&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,),</span>
    <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,),</span>
    <span class="s2">&quot;integer&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="nb">int</span><span class="p">,</span>
        <span class="nb">float</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="s2">&quot;int&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="nb">int</span><span class="p">,</span>
        <span class="nb">float</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="s2">&quot;long&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="nb">float</span><span class="p">,</span>
        <span class="nb">int</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="s2">&quot;float&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="nb">float</span><span class="p">,</span>
        <span class="nb">int</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="s2">&quot;double&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">float</span><span class="p">,),</span>
    <span class="s2">&quot;string&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,),</span>
    <span class="s2">&quot;str&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,),</span>
    <span class="s2">&quot;list&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">list</span><span class="p">,),</span>
    <span class="s2">&quot;array&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">list</span><span class="p">,),</span>
    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="nb">str</span><span class="p">,</span>
        <span class="n">Path</span><span class="p">,</span>
        <span class="n">PosixPath</span><span class="p">,</span>
        <span class="n">EmptyPath</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="nb">str</span><span class="p">,</span>
        <span class="n">Path</span><span class="p">,</span>
        <span class="n">PosixPath</span><span class="p">,</span>
        <span class="n">EmptyPath</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="s2">&quot;dict&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="nb">dict</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">}</span>


<div class="viewcode-block" id="config_key_error">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.config_key_error">[docs]</a>
<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">config_key_error</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raise ConfigurationError on KeyError.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">!r}</span><span class="s2"> parameter in configuration file.&quot;</span>
        <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span></div>



<div class="viewcode-block" id="with_config_error">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.with_config_error">[docs]</a>
<span class="k">def</span> <span class="nf">with_config_error</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add config error context.&quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">with</span> <span class="n">config_key_error</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span></div>



<span class="nd">@lru_cache</span>
<span class="k">def</span> <span class="nf">_read_defaults</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">default_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the defaults.yaml given a module name.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    module_name : str</span>
<span class="sd">        Name of the HADDOCK3 module</span>
<span class="sd">    default_only : bool</span>
<span class="sd">        If True, only the default value of each parameters found in the</span>
<span class="sd">        default.yaml will be return, else all information are retrieved.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    mod_default_config : dict</span>
<span class="sd">        A dict holding default value for each parameters of the module if</span>
<span class="sd">        default_only == True,</span>
<span class="sd">        Else a dict of dict, contraining all information present in the</span>
<span class="sd">        default.yaml file of the module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">module_name_</span> <span class="o">=</span> <span class="n">get_module_name</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
    <span class="n">pdef</span> <span class="o">=</span> <span class="n">gen_defaults_module_param_path</span><span class="p">(</span><span class="n">module_name_</span><span class="p">)</span>
    <span class="n">validate_defaults_yaml</span><span class="p">(</span><span class="n">pdef</span><span class="p">)</span>
    <span class="n">mod_default_config</span> <span class="o">=</span> <span class="n">read_from_yaml_config</span><span class="p">(</span><span class="n">pdef</span><span class="p">,</span> <span class="n">default_only</span><span class="o">=</span><span class="n">default_only</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mod_default_config</span>


<div class="viewcode-block" id="gen_defaults_module_param_path">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.gen_defaults_module_param_path">[docs]</a>
<span class="k">def</span> <span class="nf">gen_defaults_module_param_path</span><span class="p">(</span><span class="n">module_name_</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build path to default parameters of a module.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    module_name_ : str</span>
<span class="sd">        Name of the module</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Path</span>
<span class="sd">        Path to the module YAML defaults parameter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params_defaults_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
        <span class="n">haddock3_source_path</span><span class="p">,</span>
        <span class="s2">&quot;modules&quot;</span><span class="p">,</span>
        <span class="n">modules_category</span><span class="p">[</span><span class="n">module_name_</span><span class="p">],</span>
        <span class="n">module_name_</span><span class="p">,</span>
        <span class="s2">&quot;defaults.yaml&quot;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">params_defaults_path</span></div>



<div class="viewcode-block" id="setup_run">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.setup_run">[docs]</a>
<span class="k">def</span> <span class="nf">setup_run</span><span class="p">(</span>
    <span class="n">workflow_path</span><span class="p">:</span> <span class="n">FilePath</span><span class="p">,</span>
    <span class="n">restart_from</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">extend_run</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FilePath</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">ParamDict</span><span class="p">,</span> <span class="n">ParamDict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up an HADDOCK3 run.</span>

<span class="sd">    This function sets up a HADDOCK3 considering the options `--restart`</span>
<span class="sd">    and `--extend-run`. The list of actions presented below does</span>
<span class="sd">    not necessary represents the exact order in which it happens.</span>

<span class="sd">    Always performed:</span>

<span class="sd">    #. read the user configuration file</span>
<span class="sd">    #. completes the user configuration file with the default values</span>
<span class="sd">       for the non-specified parameters</span>
<span class="sd">    #. validate the config file</span>
<span class="sd">       * confirm modules&#39; names are correctly spelled</span>
<span class="sd">       * check if requested modules are installed</span>
<span class="sd">       * check additional validations</span>
<span class="sd">    #. validate modules&#39; parameters</span>
<span class="sd">    #. copy input files to data/ directory</span>
<span class="sd">       * for ``--restart`` copies only after the restart number</span>

<span class="sd">    Performed when ``--restart``:</span>

<span class="sd">    #. remove folders after --restart number</span>
<span class="sd">    #. remove also folders from `data/` dir after the ``--restart`` num</span>
<span class="sd">    #. renumber step folders according to the number of modules</span>

<span class="sd">    Performed when ``--extend-run``:</span>

<span class="sd">    #. renumber step folders according to the number of modules</span>

<span class="sd">    Performed when start from scratch:</span>

<span class="sd">    #. check mandatory arguments are present in the config file</span>
<span class="sd">    #. check run-dir exists</span>
<span class="sd">    #. copy molecules to topology key (also in ``--restart``)</span>
<span class="sd">    #. populate topology parameters (also in ``--restart``)</span>
<span class="sd">    #. copy molecules to data dir</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    workflow_path : str or pathlib.Path</span>
<span class="sd">        The path to the configuration file.</span>

<span class="sd">    restart_from : int</span>
<span class="sd">        The step to restart the run from (inclusive).</span>
<span class="sd">        Defaults to None, which ignores this option.</span>

<span class="sd">    extend_run : str or Path</span>
<span class="sd">        The path created with `haddock3-copy` to start the run from.</span>
<span class="sd">        Defaults to None, which ignores this option.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple of two dicts</span>
<span class="sd">        A dictionary with the parameters for the haddock3 modules.</span>
<span class="sd">        A dictionary with the general run parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># read the user config file from path</span>
    <span class="n">config_files</span> <span class="o">=</span> <span class="n">read_config</span><span class="p">(</span><span class="n">workflow_path</span><span class="p">)</span>

    <span class="c1"># update default non-mandatory parameters with user params</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">recursive_dict_update</span><span class="p">(</span>
        <span class="n">config_optional_general_parameters_dict</span><span class="p">,</span> <span class="n">config_files</span><span class="p">[</span><span class="s2">&quot;final_cfg&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">recursive_dict_update</span><span class="p">(</span>
        <span class="n">non_mandatory_general_parameters_defaults</span><span class="p">,</span>
        <span class="n">params</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">validate_module_names_are_not_misspelled</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># separate general from modules&#39; parameters</span>
    <span class="n">_modules_keys</span> <span class="o">=</span> <span class="n">identify_modules</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">general_params</span> <span class="o">=</span> <span class="n">remove_dict_keys</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">_modules_keys</span><span class="p">)</span>
    <span class="n">modules_params</span> <span class="o">=</span> <span class="n">remove_dict_keys</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">general_params</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="n">validate_parameters_are_not_misspelled</span><span class="p">(</span>
        <span class="n">general_params</span><span class="p">,</span>
        <span class="n">reference_parameters</span><span class="o">=</span><span class="n">ALL_POSSIBLE_GENERAL_PARAMETERS</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Validate there is no incompatible parameters in global parameters</span>
    <span class="n">validate_parameters_are_not_incompatible</span><span class="p">(</span>
        <span class="n">general_params</span><span class="p">,</span>
        <span class="n">incompatible_defaults_params</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># --extend-run configs do not define the run directory</span>
    <span class="c1"># in the config file. So we take it from the argument.</span>
    <span class="k">if</span> <span class="n">not_none</span><span class="p">(</span><span class="n">extend_run</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">extend_run</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">extend_run</span><span class="p">)</span>

        <span class="n">general_params</span><span class="p">[</span><span class="n">RUNDIR</span><span class="p">]</span> <span class="o">=</span> <span class="n">extend_run</span>

    <span class="n">check_if_modules_are_installed</span><span class="p">(</span><span class="n">modules_params</span><span class="p">)</span>
    <span class="n">check_specific_validations</span><span class="p">(</span><span class="n">general_params</span><span class="p">)</span>

    <span class="c1"># define starting conditions</span>
    <span class="c1"># consider a deeper refactor if additional conditions are implemented</span>
    <span class="c1"># @joaomcteixeira, 09 May 2022</span>
    <span class="n">from_scratch</span> <span class="o">=</span> <span class="n">restart_from</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extend_run</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="n">scratch_rest0</span> <span class="o">=</span> <span class="n">from_scratch</span> <span class="ow">or</span> <span class="n">restart_from</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">restarting_from</span> <span class="o">=</span> <span class="n">not_none</span><span class="p">(</span><span class="n">restart_from</span><span class="p">)</span>
    <span class="n">starting_from_copy</span> <span class="o">=</span> <span class="n">not_none</span><span class="p">(</span><span class="n">extend_run</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">from_scratch</span><span class="p">:</span>
        <span class="n">check_run_dir_exists</span><span class="p">(</span><span class="n">general_params</span><span class="p">[</span><span class="n">RUNDIR</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">scratch_rest0</span><span class="p">:</span>
        <span class="n">check_mandatory_argments_are_present</span><span class="p">(</span><span class="n">general_params</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">restarting_from</span><span class="p">:</span>
        <span class="n">remove_folders_after_number</span><span class="p">(</span><span class="n">general_params</span><span class="p">[</span><span class="n">RUNDIR</span><span class="p">],</span> <span class="n">restart_from</span><span class="p">)</span>
        <span class="n">_data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">general_params</span><span class="p">[</span><span class="n">RUNDIR</span><span class="p">],</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>
        <span class="n">remove_folders_after_number</span><span class="p">(</span><span class="n">_data_dir</span><span class="p">,</span> <span class="n">restart_from</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">restarting_from</span> <span class="ow">or</span> <span class="n">starting_from_copy</span><span class="p">:</span>
        <span class="c1"># get run files in folder</span>
        <span class="n">step_folders</span> <span class="o">=</span> <span class="n">get_module_steps_folders</span><span class="p">(</span><span class="n">general_params</span><span class="p">[</span><span class="n">RUNDIR</span><span class="p">])</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Uncompressing previous output files for folders: &quot;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step_folders</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="c1"># unpack the possible compressed and archived files</span>
        <span class="n">_step_folders</span> <span class="o">=</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">general_params</span><span class="p">[</span><span class="n">RUNDIR</span><span class="p">],</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">step_folders</span><span class="p">)</span>
        <span class="n">unpack_compressed_and_archived_files</span><span class="p">(</span>
            <span class="n">_step_folders</span><span class="p">,</span>
            <span class="n">general_params</span><span class="p">[</span><span class="s2">&quot;ncores&quot;</span><span class="p">],</span>
            <span class="n">dec_all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">starting_from_copy</span><span class="p">:</span>
        <span class="n">num_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">step_folders</span><span class="p">)</span>
        <span class="n">_num_modules</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">modules_params</span><span class="p">)</span>
        <span class="c1"># has to consider the folders already present, plus the new folders</span>
        <span class="c1"># in the configuration file</span>
        <span class="n">zero_fill</span><span class="o">.</span><span class="n">set_zerofill_number</span><span class="p">(</span><span class="n">num_steps</span> <span class="o">+</span> <span class="n">_num_modules</span><span class="p">)</span>

        <span class="n">max_mols</span> <span class="o">=</span> <span class="n">read_num_molecules_from_folder</span><span class="p">(</span><span class="n">extend_run</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">copy_molecules_to_topology</span><span class="p">(</span>
            <span class="n">general_params</span><span class="p">[</span><span class="s2">&quot;molecules&quot;</span><span class="p">],</span>
            <span class="n">modules_params</span><span class="p">[</span><span class="s2">&quot;topoaa.1&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">modules_params</span><span class="p">[</span><span class="s2">&quot;topoaa.1&quot;</span><span class="p">][</span><span class="s2">&quot;molecules&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">max_molecules_allowed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Too many molecules defined, max is </span><span class="si">{</span><span class="n">max_molecules_allowed</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>  <span class="c1"># noqa: E501</span>

        <span class="n">zero_fill</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">modules_params</span><span class="p">)</span>

        <span class="n">populate_topology_molecule_params</span><span class="p">(</span><span class="n">modules_params</span><span class="p">[</span><span class="s2">&quot;topoaa.1&quot;</span><span class="p">])</span>
        <span class="n">populate_mol_parameters</span><span class="p">(</span><span class="n">modules_params</span><span class="p">)</span>

        <span class="n">max_mols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">modules_params</span><span class="p">[</span><span class="s2">&quot;topoaa.1&quot;</span><span class="p">][</span><span class="s2">&quot;molecules&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">from_scratch</span><span class="p">:</span>
        <span class="n">_prev</span><span class="p">,</span> <span class="n">_new</span> <span class="o">=</span> <span class="n">renum_step_folders</span><span class="p">(</span><span class="n">general_params</span><span class="p">[</span><span class="n">RUNDIR</span><span class="p">])</span>
        <span class="n">renum_step_folders</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">general_params</span><span class="p">[</span><span class="n">RUNDIR</span><span class="p">],</span> <span class="s2">&quot;data&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">UNPACK_FOLDERS</span><span class="p">:</span>  <span class="c1"># only if there was any folder unpacked</span>
            <span class="n">update_unpacked_names</span><span class="p">(</span><span class="n">_prev</span><span class="p">,</span> <span class="n">_new</span><span class="p">,</span> <span class="n">UNPACK_FOLDERS</span><span class="p">)</span>
        <span class="n">update_step_contents_to_step_names</span><span class="p">(</span>
            <span class="n">_prev</span><span class="p">,</span>
            <span class="n">_new</span><span class="p">,</span>
            <span class="n">general_params</span><span class="p">[</span><span class="n">RUNDIR</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="n">validate_modules_params</span><span class="p">(</span><span class="n">modules_params</span><span class="p">,</span> <span class="n">max_mols</span><span class="p">)</span>

    <span class="c1"># create datadir</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="n">create_data_dir</span><span class="p">(</span><span class="n">general_params</span><span class="p">[</span><span class="n">RUNDIR</span><span class="p">])</span>

    <span class="c1"># Add workflow configuration file in data directory</span>
    <span class="n">enhanced_haddock_params</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">general_params</span><span class="p">)</span>
    <span class="n">enhanced_haddock_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">modules_params</span><span class="p">)</span>
    <span class="n">config_files</span><span class="p">[</span><span class="s2">&quot;enhanced_haddock_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">enhanced_haddock_params</span>
    <span class="n">config_saves</span> <span class="o">=</span> <span class="n">save_configuration_files</span><span class="p">(</span><span class="n">config_files</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">)</span>  <span class="c1"># noqa : F841</span>

    <span class="k">if</span> <span class="n">scratch_rest0</span><span class="p">:</span>
        <span class="n">copy_molecules_to_data_dir</span><span class="p">(</span>
            <span class="n">data_dir</span><span class="p">,</span>
            <span class="n">modules_params</span><span class="p">[</span><span class="s2">&quot;topoaa.1&quot;</span><span class="p">],</span>
            <span class="n">preprocess</span><span class="o">=</span><span class="n">general_params</span><span class="p">[</span><span class="s2">&quot;preprocess&quot;</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">starting_from_copy</span><span class="p">:</span>
        <span class="n">copy_input_files_to_data_dir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">modules_params</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">num_steps</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">restarting_from</span><span class="p">:</span>
        <span class="c1"># copies only the input molecules needed</span>
        <span class="n">_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">modules_params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">_partial_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">modules_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_keys</span><span class="p">[</span><span class="n">restart_from</span><span class="p">:]}</span>
        <span class="n">copy_input_files_to_data_dir</span><span class="p">(</span>
            <span class="n">data_dir</span><span class="p">,</span>
            <span class="n">_partial_params</span><span class="p">,</span>
            <span class="n">start</span><span class="o">=</span><span class="n">restart_from</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># copies everything</span>
        <span class="n">copy_input_files_to_data_dir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">modules_params</span><span class="p">)</span>

    <span class="c1"># grant write permissions to data/ dir</span>
    <span class="n">make_writeable_recursive</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>

    <span class="c1"># return the modules&#39; parameters and general parameters separately</span>
    <span class="k">return</span> <span class="n">modules_params</span><span class="p">,</span> <span class="n">general_params</span></div>



<div class="viewcode-block" id="save_configuration_files">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.save_configuration_files">[docs]</a>
<span class="k">def</span> <span class="nf">save_configuration_files</span><span class="p">(</span><span class="n">configs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">datadir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write a copy of configuration files (GitHub issue #578).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    configs : dict</span>
<span class="sd">        Dictionnary holding the various configuration files</span>
<span class="sd">        [&#39;raw_input, &#39;cleaned_input&#39;, &#39;loaded_cleaned_input&#39;,</span>
<span class="sd">        &#39;final_cfg&#39;, &#39;enhanced_haddock_params&#39;]</span>
<span class="sd">    datadir : str or :py:class:`libpath.Path`</span>
<span class="sd">        Directory where to write the configuration.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    added_files : dict</span>
<span class="sd">        Dictionary of paths leading to saved configuration files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create directory</span>
    <span class="n">confpaths</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;configurations/&quot;</span><span class="p">)</span>
    <span class="n">confpaths</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Initiate files data</span>
    <span class="n">infofile</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;raw_input&quot;</span><span class="p">:</span> <span class="p">(</span>
            <span class="s2">&quot;An untouched copy of the raw input file, &quot;</span> <span class="s2">&quot;as provided by the user.&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;cleaned_input&quot;</span><span class="p">:</span> <span class="p">(</span>
            <span class="s2">&quot;Pre-parsed input file where (eventually) &quot;</span>
            <span class="s2">&quot;some indexing and modifications were &quot;</span>
            <span class="s2">&quot;applied to ensure further processing.&quot;</span>
        <span class="p">),</span>
        <span class="s2">&quot;enhanced_haddock_params&quot;</span><span class="p">:</span> <span class="p">(</span>
            <span class="s2">&quot;Final input file with detailed default parameters.&quot;</span>
        <span class="p">),</span>
    <span class="p">}</span>
    <span class="n">added_files</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Set list of configurations that wish to be saved</span>
    <span class="n">list_save_conf</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;raw_input&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cleaned_input&quot;</span><span class="p">,</span>
        <span class="s2">&quot;enhanced_haddock_params&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Loop over configuration files</span>
    <span class="k">for</span> <span class="n">confname</span> <span class="ow">in</span> <span class="n">list_save_conf</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">confdt</span> <span class="o">=</span> <span class="n">configs</span><span class="p">[</span><span class="n">confname</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">toml_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">confpaths</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">confname</span><span class="si">}</span><span class="s2">.toml&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">confdt</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># Save toml version</span>
            <span class="n">save_config</span><span class="p">(</span><span class="n">confdt</span><span class="p">,</span> <span class="n">toml_fpath</span><span class="p">)</span>
            <span class="c1"># Save json version</span>
            <span class="n">json_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">confpaths</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">confname</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
            <span class="n">jsonconf</span> <span class="o">=</span> <span class="n">recursive_convert_paths_to_strings</span><span class="p">(</span><span class="n">confdt</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_fpath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">jsonconf</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">toml_fpath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">confdt</span><span class="p">)</span>

        <span class="n">added_files</span><span class="p">[</span><span class="n">confname</span><span class="p">]</span> <span class="o">=</span> <span class="n">toml_fpath</span>

    <span class="c1"># Add README to help user</span>
    <span class="n">readmepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">confpaths</span><span class="p">,</span> <span class="s2">&quot;README.txt&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">readmepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="mi">80</span><span class="si">}</span><span class="se">\n</span><span class="s2"># Information about configuration &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;files present in the same directory #</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="mi">80</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">confname</span> <span class="ow">in</span> <span class="n">list_save_conf</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">confname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">added_files</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">added_files</span><span class="p">[</span><span class="n">confname</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;: </span><span class="si">{</span><span class="n">infofile</span><span class="p">[</span><span class="n">confname</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">added_files</span><span class="p">[</span><span class="s2">&quot;readme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">readmepath</span>

    <span class="c1"># Return mapper to added files</span>
    <span class="k">return</span> <span class="n">added_files</span></div>



<div class="viewcode-block" id="validate_params">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.validate_params">[docs]</a>
<span class="k">def</span> <span class="nf">validate_params</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate the parameter file.</span>

<span class="sd">    #1 : checks for mandatory parameters</span>
<span class="sd">    #2 : checks for correct modules</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">check_mandatory_argments_are_present</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">validate_modules_names</span><span class="p">(</span><span class="n">params</span><span class="p">)</span></div>



<div class="viewcode-block" id="check_mandatory_argments_are_present">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.check_mandatory_argments_are_present">[docs]</a>
<span class="k">def</span> <span class="nf">check_mandatory_argments_are_present</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Confirm order key exists in config.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">config_mandatory_general_parameters</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parameter </span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2"> is not defined in the configuration file. &quot;</span>
                <span class="s2">&quot;Please refer to DOCUMENTATION-LINK for more information.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="n">_msg</span><span class="p">)</span>
    <span class="k">return</span></div>



<div class="viewcode-block" id="validate_modules_names">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.validate_modules_names">[docs]</a>
<span class="nd">@with_config_error</span>
<span class="k">def</span> <span class="nf">validate_modules_names</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate all modules names are spelled correctly.&quot;&quot;&quot;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">set</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">config_mandatory_general_parameters</span><span class="p">)</span>
        <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">non_mandatory_general_parameters_defaults</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">get_module_name</span><span class="p">(</span><span class="n">module</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">modules_category</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Module </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> not found in HADDOCK3 library. &quot;</span>
                <span class="s2">&quot;Please refer to the list of available modules at: &quot;</span>
                <span class="s2">&quot;DOCUMENTATION-LINK&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="n">_msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="validate_modules_params">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.validate_modules_params">[docs]</a>
<span class="nd">@with_config_error</span>
<span class="k">def</span> <span class="nf">validate_modules_params</span><span class="p">(</span><span class="n">modules_params</span><span class="p">:</span> <span class="n">ParamMap</span><span class="p">,</span> <span class="n">max_mols</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate individual parameters for each module.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ConfigError</span>
<span class="sd">        If there is any parameter given by the user that is not defined</span>
<span class="sd">        in the defaults.cfg of the module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">modules_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">module_name</span> <span class="o">=</span> <span class="n">get_module_name</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="n">_read_defaults</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">defaults</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Check for parameter incompatibilities</span>
        <span class="n">module_incompatibilities</span> <span class="o">=</span> <span class="n">find_incompatible_parameters</span><span class="p">(</span>
            <span class="n">gen_defaults_module_param_path</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">validate_parameters_are_not_incompatible</span><span class="p">(</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">module_incompatibilities</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;An issue was discovered in module [</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">]: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">modules_using_resdic</span><span class="p">:</span>
            <span class="n">confirm_resdic_chainid_length</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="n">expandable_params</span> <span class="o">=</span> <span class="n">get_expandable_parameters</span><span class="p">(</span>
            <span class="n">args</span><span class="p">,</span>
            <span class="n">defaults</span><span class="p">,</span>
            <span class="n">module_name</span><span class="p">,</span>
            <span class="n">max_mols</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">all_parameters</span> <span class="o">=</span> <span class="nb">set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">extract_keys_recursive</span><span class="p">(</span><span class="n">defaults</span><span class="p">)),</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">non_mandatory_general_parameters_defaults</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="n">expandable_params</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">extract_keys_recursive</span><span class="p">(</span><span class="n">args</span><span class="p">))</span> <span class="o">-</span> <span class="n">all_parameters</span>

        <span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
            <span class="n">matched</span> <span class="o">=</span> <span class="n">fuzzy_match</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">all_parameters</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">pretty_print</span><span class="p">(</span><span class="n">match</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; * &#39;</span><span class="si">{</span><span class="n">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; did you mean &#39;</span><span class="si">{</span><span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;?&quot;</span>

            <span class="n">_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;The following parameters do not match any expected &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;parameters for module </span><span class="si">{</span><span class="n">module_name</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">pretty_print</span><span class="p">,</span><span class="w"> </span><span class="n">matched</span><span class="p">))</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="n">_msg</span><span class="p">)</span>

        <span class="c1"># Now that existence of the parameter was checked,</span>
        <span class="c1"># it is time to validate the type and value taken by this param</span>
        <span class="n">validate_module_params_values</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="c1"># Validate ncs parameters</span>
        <span class="n">validate_ncs_params</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="c1"># Update parameters with defaults ones</span>
        <span class="n">_missing_defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">param</span><span class="p">:</span> <span class="n">default</span>
            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">default</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_missing_defaults</span><span class="p">)</span></div>



<div class="viewcode-block" id="validate_module_params_values">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.validate_module_params_values">[docs]</a>
<span class="k">def</span> <span class="nf">validate_module_params_values</span><span class="p">(</span><span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate individual parameters for a module.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    module_name :</span>
<span class="sd">        Name of the module to be analyzed</span>
<span class="sd">    args : dict</span>
<span class="sd">        Dictionnary of key/value present in user config file for a module</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ConfigError</span>
<span class="sd">        If there is any parameter given by the user that is not following the</span>
<span class="sd">        types or ranges/choices allowed in the defaults.cfg of the module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load all parameters information from &#39;defaults.cfg&#39;</span>
    <span class="n">default_conf_params</span> <span class="o">=</span> <span class="n">_read_defaults</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">default_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># Loop over user queried parameters keys/values</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">validate_value</span><span class="p">(</span><span class="n">default_conf_params</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span></div>



<div class="viewcode-block" id="validate_value">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.validate_value">[docs]</a>
<span class="k">def</span> <span class="nf">validate_value</span><span class="p">(</span><span class="n">default_yaml</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate queried value for a specific parameter of a module.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    default_yaml : dict</span>
<span class="sd">        Dictionnary of key/value present in user config file for a module</span>
<span class="sd">    key : str</span>
<span class="sd">        Key to be analyzed</span>
<span class="sd">    value : [bool, int, float, str, list]</span>
<span class="sd">        The provided value for a parameter</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ConfigError</span>
<span class="sd">        If there is any parameter given by the user that is not following the</span>
<span class="sd">        types or ranges/choices allowed in the defaults.cfg of the module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Special case for molecules...</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">default_yaml</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="s2">&quot;group&quot;</span> <span class="ow">in</span> <span class="n">default_yaml</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">default_yaml</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;group&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;molecules&quot;</span><span class="p">:</span>
            <span class="k">return</span>

    <span class="c1"># Series of checks</span>
    <span class="k">if</span> <span class="n">_msg</span> <span class="o">:=</span> <span class="n">validate_param_type</span><span class="p">(</span><span class="n">default_yaml</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config error for parameter &quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&quot;: </span><span class="si">{</span><span class="n">_msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_msg</span> <span class="o">:=</span> <span class="n">validate_param_range</span><span class="p">(</span><span class="n">default_yaml</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Config error for parameter &quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&quot;: </span><span class="si">{</span><span class="n">_msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

    <span class="c1"># FIXME: add more checks here ?</span>


<div class="viewcode-block" id="validate_param_type">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.validate_param_type">[docs]</a>
<span class="k">def</span> <span class="nf">validate_param_type</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if provided parameter type is similar to defined defaults ones.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param : dict</span>
<span class="sd">        Dictionnary of key/value present in user config file for a module</span>
<span class="sd">    val : [bool, int, float, str, list]</span>
<span class="sd">        The provided value for a parameter</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    May return a string explaining the issue with the provided value type</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">return</span>
    <span class="c1"># Load type from string to python class</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">allowed_types</span> <span class="o">=</span> <span class="n">TYPES_MAPPER</span><span class="p">[</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]]</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Unrecognized default type &quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
    <span class="c1"># Check if both of the same type</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">query_type</span> <span class="o">:=</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_types</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Wrong provided type &quot;</span><span class="si">{</span><span class="n">query_type</span><span class="si">}</span><span class="s1">&quot; with value &quot;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&quot;. &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;It should be of type &quot;</span><span class="si">{</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot; &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;(e.g: </span><span class="si">{</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="validate_param_range">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.validate_param_range">[docs]</a>
<span class="k">def</span> <span class="nf">validate_param_range</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if provided value is in range/choices defined for this parameter.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param : dict</span>
<span class="sd">        Dictionnary of key/value present in user config file for a module</span>
<span class="sd">    val : [bool, int, float, str, list]</span>
<span class="sd">        The provided value for a parameter</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    May return a string explaining the issue with the provided value range</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Case for choices</span>
    <span class="k">if</span> <span class="s2">&quot;choices&quot;</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">choices</span> <span class="o">:=</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;choices&quot;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Value &quot;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&quot; is not among the accepted choices: </span><span class="si">{</span><span class="n">choices</span><span class="si">}</span><span class="s1">&#39;</span>  <span class="c1"># noqa : E501</span>
    <span class="c1"># Case for ranges</span>
    <span class="k">elif</span> <span class="s2">&quot;min&quot;</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot;max&quot;</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Value &quot;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&quot; is not in the allowed boundaries &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;ranging from </span><span class="si">{</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
    <span class="c1"># Case for lists</span>
    <span class="k">elif</span> <span class="s2">&quot;minitems&quot;</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot;maxitems&quot;</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nbitems</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;minitems&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">nbitems</span> <span class="o">&gt;</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;maxitems&quot;</span><span class="p">]:</span>
            <span class="n">_desc</span> <span class="o">=</span> <span class="s2">&quot;under&quot;</span> <span class="k">if</span> <span class="n">nbitems</span> <span class="o">&lt;</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;minitems&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;exceeding&quot;</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Number of items found in &quot;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&quot; is </span><span class="si">{</span><span class="n">_desc</span><span class="si">}</span><span class="s1"> the &#39;</span>
                <span class="s2">&quot;permitted limit. It should range from &quot;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;minitems&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;maxitems&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
    <span class="c1"># Case for strings</span>
    <span class="k">elif</span> <span class="s2">&quot;minchars&quot;</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot;maxchars&quot;</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nbchars</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;minchars&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">nbchars</span> <span class="o">&gt;</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;maxchars&quot;</span><span class="p">]:</span>
            <span class="n">_desc</span> <span class="o">=</span> <span class="s2">&quot;under&quot;</span> <span class="k">if</span> <span class="n">nbchars</span> <span class="o">&lt;</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;minitems&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;exceeding&quot;</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Number of items found in &quot;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&quot; is </span><span class="si">{</span><span class="n">_desc</span><span class="si">}</span><span class="s1"> the &#39;</span>
                <span class="s2">&quot;permitted limit. It should range from &quot;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;minchars&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;maxchars&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span></div>



<div class="viewcode-block" id="validate_ncs_params">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.validate_ncs_params">[docs]</a>
<span class="k">def</span> <span class="nf">validate_ncs_params</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate Non-Crystallographic Symmetry parameters.</span>

<span class="sd">    This is a particular case where:</span>
<span class="sd">    - ncs_sta1_X == ncs_sta2_X</span>
<span class="sd">    - ncs_end1_X == ncs_end2_X</span>
<span class="sd">    - ncs_seg1_X != ncs_seg2_X</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    params : dict</span>
<span class="sd">        Dictionary of key/value present in user config file for a module</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ConfigurationError</span>
<span class="sd">        Issue detected when validating NCS parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Check if ncs_on == False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;ncs_on&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># Maybe this module do not have ncs parameters, so we skip it</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># At this stage, ncs_on == True</span>
    <span class="n">base_ncs_param_names</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;ncs_sta&quot;</span><span class="p">,</span> <span class="s2">&quot;ncs_end&quot;</span><span class="p">,</span> <span class="s2">&quot;ncs_seg&quot;</span><span class="p">,</span> <span class="p">)</span>
    <span class="c1"># Read and group ncs parameters together</span>
    <span class="n">groupped_ncs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">paramname</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Check if this is a ncs parameter</span>
        <span class="k">if</span> <span class="n">paramname</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span> <span class="ow">in</span> <span class="n">base_ncs_param_names</span><span class="p">:</span>
            <span class="c1"># Point two interesting values here</span>
            <span class="n">first_or_second</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">paramname</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">paramname</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># Point param type (&quot;sta&quot;, &quot;end&quot;, or &quot;seg&quot;)</span>
            <span class="n">param_type</span> <span class="o">=</span> <span class="n">paramname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Point/Create holding dict(s)</span>
            <span class="n">ncs_group</span> <span class="o">=</span> <span class="n">groupped_ncs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">ncs_type</span> <span class="o">=</span> <span class="n">ncs_group</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">param_type</span><span class="p">,</span> <span class="p">{})</span>
            <span class="c1"># Hold value</span>
            <span class="n">ncs_type</span><span class="p">[</span><span class="n">first_or_second</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># Validate them</span>
    <span class="n">error_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Loop over number of definitions (_X)</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">paramtype_values</span> <span class="ow">in</span> <span class="n">groupped_ncs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Loop over parameter types</span>
        <span class="k">for</span> <span class="n">paramtype</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">paramtype_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">two_values</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="c1"># First make sure both are defined !</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">two_values</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Not two values set of `ncs_</span><span class="si">{</span><span class="n">paramtype</span><span class="si">}</span><span class="s2">Y_</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">error_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">paramtype</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;sta&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="p">):</span>
                <span class="c1"># Check they are not similar (wrong!)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">two_values</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Values set of `ncs_</span><span class="si">{</span><span class="n">paramtype</span><span class="si">}</span><span class="s2">Y_</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2"> must be equal: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;we parsed `</span><span class="si">{</span><span class="n">two_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">` and `</span><span class="si">{</span><span class="n">two_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">`&quot;</span>
                        <span class="p">)</span>
                    <span class="n">error_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># paramtype == &quot;seg&quot;</span>
                <span class="c1"># Check they are similar (wrong!)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Chain/Segment IDs for `ncs_</span><span class="si">{</span><span class="n">paramtype</span><span class="si">}</span><span class="s2">Y_</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2"> must be &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;different: we parsed `</span><span class="si">{</span><span class="n">two_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">` and&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; `</span><span class="si">{</span><span class="n">two_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">`&quot;</span>
                        <span class="p">)</span>
                    <span class="n">error_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Validate value of `numncs`</span>
    <span class="n">ncs_suffixes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">groupped_ncs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="c1"># Case when number of definition do not match</span>
    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;nncs&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ncs_suffixes</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Number of NCS restraints (`nncs = </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;nncs&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">`) &#39;</span>
            <span class="s2">&quot; do not match with the number of defined NCS restraints &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ncs_suffixes</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
        <span class="n">error_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Case when numbers do not match</span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">ncs_suffixes</span><span class="p">)</span> <span class="o">!=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;nncs&quot;</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Number of NCS restraints (`nncs = </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;nncs&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">`) &#39;</span>
                <span class="s2">&quot; do not match with the number of defined NCS restraints &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">ncs_suffixes</span><span class="p">])</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
            <span class="n">error_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Here we fall into the error case</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">error_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Build user message</span>
        <span class="n">_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Some errors were discovered in the NCS restraints definition:&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">error_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Raise error</span>
        <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="n">_msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="check_if_modules_are_installed">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.check_if_modules_are_installed">[docs]</a>
<span class="k">def</span> <span class="nf">check_if_modules_are_installed</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">ParamMap</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate if third party-libraries are installed.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">module_import_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;haddock&quot;</span><span class="p">,</span>
                <span class="s2">&quot;modules&quot;</span><span class="p">,</span>
                <span class="n">modules_category</span><span class="p">[</span><span class="n">get_module_name</span><span class="p">(</span><span class="n">module_name</span><span class="p">)],</span>
                <span class="n">get_module_name</span><span class="p">(</span><span class="n">module_name</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">module_lib</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_import_name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">module_lib</span><span class="o">.</span><span class="n">HaddockModule</span><span class="o">.</span><span class="n">confirm_installation</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;A problem occurred while assessing if module &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module_name</span><span class="si">!r}</span><span class="s2"> is installed in your system. Have you &quot;</span>
                <span class="s2">&quot;installed the packages required to run this module? If &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;yes, write us at </span><span class="si">{</span><span class="n">contact_us</span><span class="si">!r}</span><span class="s2"> describing your system &quot;</span>
                <span class="s2">&quot;and the problems you are facing. If not, please install &quot;</span>
                <span class="s2">&quot;the required packages to use the module.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">ModuleError</span><span class="p">(</span><span class="n">_msg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span></div>



<span class="c1"># depecrated</span>
<span class="c1"># def convert_params_to_path(params):</span>
<span class="c1">#     &quot;&quot;&quot;Convert parameters to path.&quot;&quot;&quot;</span>
<span class="c1">#     convert_molecules_to_path(params)</span>
<span class="c1">#     convert_run_dir_to_path(params)</span>
<span class="c1">#     return</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># @with_config_error</span>
<span class="c1"># def convert_molecules_to_path(params):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Convert molecules path strings to Python Paths.</span>
<span class="c1">#</span>
<span class="c1">#     And... convert `molecules` in `params` to a dictionary where keys</span>
<span class="c1">#     are `key` + `sep` + enumerate(`start`), and values are the new Path</span>
<span class="c1">#     values.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     molecules = make_list_if_string(params[&#39;molecules&#39;])</span>
<span class="c1">#     params[&#39;molecules&#39;] = [Path(i).resolve() for i in molecules]</span>
<span class="c1">#     return</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># @with_config_error</span>
<span class="c1"># def convert_run_dir_to_path(params):</span>
<span class="c1">#     &quot;&quot;&quot;Convert run directory value to Python Path.&quot;&quot;&quot;</span>
<span class="c1">#     params[RUNDIR] = Path(params[RUNDIR])</span>
<span class="c1">#     return</span>


<div class="viewcode-block" id="create_data_dir">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.create_data_dir">[docs]</a>
<span class="nd">@with_config_error</span>
<span class="k">def</span> <span class="nf">create_data_dir</span><span class="p">(</span><span class="n">run_dir</span><span class="p">:</span> <span class="n">FilePath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create initial files for HADDOCK3 run.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pathlib.Path</span>
<span class="sd">        A path referring only to &#39;data&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>
    <span class="n">data_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_dir</span></div>



<div class="viewcode-block" id="copy_molecules_to_topology">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.copy_molecules_to_topology">[docs]</a>
<span class="nd">@with_config_error</span>
<span class="k">def</span> <span class="nf">copy_molecules_to_topology</span><span class="p">(</span>
    <span class="n">molecules</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">topoaa_params</span><span class="p">:</span> <span class="n">ParamMap</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Copy molecules to mandatory topology module.&quot;&quot;&quot;</span>
    <span class="n">topoaa_params</span><span class="p">[</span><span class="s2">&quot;molecules&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="n">transform_to_list</span><span class="p">(</span><span class="n">molecules</span><span class="p">)))</span></div>



<div class="viewcode-block" id="copy_molecules_to_data_dir">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.copy_molecules_to_data_dir">[docs]</a>
<span class="k">def</span> <span class="nf">copy_molecules_to_data_dir</span><span class="p">(</span>
    <span class="n">data_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">topoaa_params</span><span class="p">:</span> <span class="n">ParamMap</span><span class="p">,</span> <span class="n">preprocess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Copy molecules to data directory and to topoaa parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_dir : Path</span>
<span class="sd">        The data/ directory inside the run directory. Must contain</span>
<span class="sd">        reference to the run directory.</span>

<span class="sd">    topoaa_params : dict</span>
<span class="sd">        A dictionary containing the topoaa parameters.</span>

<span class="sd">    preprocess : bool</span>
<span class="sd">        Whether to preprocess input molecules. Defaults to ``True``.</span>
<span class="sd">        See :py:mod:`haddock.gear.preprocessing`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">topoaa_dir</span> <span class="o">=</span> <span class="n">zero_fill</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="s2">&quot;topoaa&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># define paths</span>
    <span class="n">data_topoaa_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">topoaa_dir</span><span class="p">)</span>
    <span class="n">data_topoaa_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">rel_data_topoaa_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">data_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">topoaa_dir</span><span class="p">)</span>
    <span class="n">original_mol_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s2">&quot;original_molecules&quot;</span><span class="p">)</span>

    <span class="n">new_molecules</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="n">copy</span><span class="p">(</span><span class="n">topoaa_params</span><span class="p">[</span><span class="s2">&quot;molecules&quot;</span><span class="p">]):</span>
        <span class="n">check_if_path_exists</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>

        <span class="n">mol_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="n">preprocess</span><span class="p">:</span>  <span class="c1"># preprocess PDB files</span>
            <span class="n">top_fname</span> <span class="o">=</span> <span class="n">topoaa_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ligand_top_fname&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">new_residues</span> <span class="o">=</span> <span class="n">read_additional_residues</span><span class="p">(</span><span class="n">top_fname</span><span class="p">)</span> <span class="k">if</span> <span class="n">top_fname</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="n">new_pdbs</span> <span class="o">=</span> <span class="n">process_pdbs</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">user_supported_residues</span><span class="o">=</span><span class="n">new_residues</span><span class="p">)</span>

            <span class="c1"># copy the original molecule</span>
            <span class="n">original_mol_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">original_mol</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">original_mol_dir</span><span class="p">,</span> <span class="n">mol_name</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">original_mol</span><span class="p">)</span>

            <span class="c1"># write the new processed molecule</span>
            <span class="n">new_pdb</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_pdbs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">data_topoaa_dir</span><span class="p">,</span> <span class="n">mol_name</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">new_pdb</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">data_topoaa_dir</span><span class="p">,</span> <span class="n">mol_name</span><span class="p">))</span>

        <span class="n">new_molecules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">rel_data_topoaa_dir</span><span class="p">,</span> <span class="n">mol_name</span><span class="p">))</span>

    <span class="n">topoaa_params</span><span class="p">[</span><span class="s2">&quot;molecules&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">new_molecules</span><span class="p">)</span></div>



<div class="viewcode-block" id="copy_input_files_to_data_dir">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.copy_input_files_to_data_dir">[docs]</a>
<span class="k">def</span> <span class="nf">copy_input_files_to_data_dir</span><span class="p">(</span>
    <span class="n">data_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">modules_params</span><span class="p">:</span> <span class="n">ParamMap</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Copy input files to data directory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_dir : Path</span>
<span class="sd">        The data/ directory inside the run directory. Must contain</span>
<span class="sd">        reference to the run directory.</span>

<span class="sd">    modules_params : dict</span>
<span class="sd">        A dictionary with the parameters of the modules. The paths to</span>
<span class="sd">        data in the dictionary are updated to the new paths copied</span>
<span class="sd">        to the data/ folder.</span>

<span class="sd">    start : int, default to 0</span>
<span class="sd">        The starting number of the step folders prefix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rel_data_dir</span> <span class="o">=</span> <span class="n">data_dir</span><span class="o">.</span><span class="n">name</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">modules_params</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">):</span>
        <span class="n">end_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">zero_fill</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">get_module_name</span><span class="p">(</span><span class="n">module</span><span class="p">),</span> <span class="n">i</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">parameter</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_fname&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
                    <span class="c1"># path is created here to avoid creating empty folders</span>
                    <span class="c1"># for those modules without &#39;_fname&#39; parameters</span>
                    <span class="n">pf</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">end_path</span><span class="p">)</span>
                    <span class="n">pf</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">check_if_path_exists</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">target_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">target_path</span><span class="p">)</span>
                    <span class="n">_p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">rel_data_dir</span><span class="p">,</span> <span class="n">end_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="n">modules_params</span><span class="p">[</span><span class="n">module</span><span class="p">][</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">_p</span>
                    <span class="c1"># account for input .tgz files</span>
                    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;tgz&quot;</span><span class="p">):</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uncompressing tar </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">target_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
                            <span class="n">fin</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span></div>



<div class="viewcode-block" id="check_run_dir_exists">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.check_run_dir_exists">[docs]</a>
<span class="k">def</span> <span class="nf">check_run_dir_exists</span><span class="p">(</span><span class="n">run_dir</span><span class="p">:</span> <span class="n">FilePath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check whether the run directory exists.&quot;&quot;&quot;</span>
    <span class="n">_p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_p</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_p</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">RUNDIR</span><span class="si">!r}</span><span class="s2"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">_p</span><span class="p">)</span><span class="si">!r}</span><span class="s2"> exists and is not empty. &quot;</span>
            <span class="s2">&quot;We can&#39;t work on it unless you provide the `--restart` &quot;</span>
            <span class="s2">&quot;option. If you want to start a run from scratch, &quot;</span>
            <span class="s2">&quot;indicate a new folder, or manually delete this one first, &quot;</span>
            <span class="s2">&quot;or use `--restart 0`.&quot;</span>
        <span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">get_goodbye_help</span><span class="p">())</span></div>



<div class="viewcode-block" id="identify_modules">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.identify_modules">[docs]</a>
<span class="k">def</span> <span class="nf">identify_modules</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identify keys (headings) belonging to HADDOCK3 modules.&quot;&quot;&quot;</span>
    <span class="n">modules_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">params</span> <span class="k">if</span> <span class="n">get_module_name</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">modules_category</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">modules_keys</span></div>



<div class="viewcode-block" id="inject_in_modules">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.inject_in_modules">[docs]</a>
<span class="k">def</span> <span class="nf">inject_in_modules</span><span class="p">(</span><span class="n">modules_params</span><span class="p">:</span> <span class="n">ParamMap</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Inject a parameter in each module.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">modules_params</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;key </span><span class="si">{key!r}</span><span class="s2"> already in </span><span class="si">{module!r}</span><span class="s2"> parameters. &quot;</span> <span class="s2">&quot;Can&#39;t inject.&quot;</span>
            <span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>



<div class="viewcode-block" id="validate_module_names_are_not_misspelled">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.validate_module_names_are_not_misspelled">[docs]</a>
<span class="k">def</span> <span class="nf">validate_module_names_are_not_misspelled</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">ParamMap</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate module names are not misspelled in step definitions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    params : dict</span>
<span class="sd">        The user configuration file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params_to_check</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">get_module_name</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">validate_parameters_are_not_misspelled</span><span class="p">(</span>
        <span class="n">params_to_check</span><span class="p">,</span>
        <span class="n">reference_parameters</span><span class="o">=</span><span class="n">modules_names</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span></div>



<div class="viewcode-block" id="validate_parameters_are_not_incompatible">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.validate_parameters_are_not_incompatible">[docs]</a>
<span class="k">def</span> <span class="nf">validate_parameters_are_not_incompatible</span><span class="p">(</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">ParamMap</span><span class="p">,</span>
        <span class="n">incompatible_params</span><span class="p">:</span> <span class="n">ParamMap</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate parameters are not incompatible.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    params : ParamMap</span>
<span class="sd">        A mapping of parameter names to their values.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If any parameter in `params` is incompatible with another parameter</span>
<span class="sd">        as defined by `incompatible_params`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">limiting_param</span><span class="p">,</span> <span class="n">incompatibilities</span> <span class="ow">in</span> <span class="n">incompatible_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Check if the limiting parameter is present in the parameters</span>
        <span class="k">if</span> <span class="n">limiting_param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="c1"># Point incompatibilities for the value of the limiting parameter</span>
            <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="n">limiting_param</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">incompatibilities</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">active_incompatibilities</span> <span class="o">=</span> <span class="n">incompatibilities</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="n">limiting_param</span><span class="p">]]</span>
            <span class="c1"># Check each incompatibility for the limiting parameter</span>
            <span class="k">for</span> <span class="n">incompatible_param</span><span class="p">,</span> <span class="n">incompatible_value</span> <span class="ow">in</span> <span class="n">active_incompatibilities</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Check if the incompatible parameter is present and has the incompatible value</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">incompatible_param</span><span class="p">)</span> <span class="o">==</span> <span class="n">incompatible_value</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Parameter `</span><span class="si">{</span><span class="n">limiting_param</span><span class="si">}</span><span class="s2">` with value &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="n">limiting_param</span><span class="p">]</span><span class="si">}</span><span class="s2">` is incompatible with &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">incompatible_param</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">incompatible_value</span><span class="si">}</span><span class="s2">`.&quot;</span>
                        <span class="p">)</span></div>



<div class="viewcode-block" id="validate_parameters_are_not_misspelled">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.validate_parameters_are_not_misspelled">[docs]</a>
<span class="k">def</span> <span class="nf">validate_parameters_are_not_misspelled</span><span class="p">(</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">reference_parameters</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate general parameters are not misspelled.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">param_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reference_parameters</span><span class="p">:</span>
            <span class="n">matched</span> <span class="o">=</span> <span class="n">fuzzy_match</span><span class="p">([</span><span class="n">param_name</span><span class="p">],</span> <span class="n">reference_parameters</span><span class="p">)</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parameter </span><span class="si">{</span><span class="n">param_name</span><span class="si">!r}</span><span class="s2"> is not a valid general parameter,&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; did you mean </span><span class="si">{</span><span class="n">matched</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">!r}</span><span class="s2">?&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span></div>



<div class="viewcode-block" id="check_specific_validations">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.check_specific_validations">[docs]</a>
<span class="nd">@with_config_error</span>
<span class="k">def</span> <span class="nf">check_specific_validations</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">ParamMap</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make specific validations.&quot;&quot;&quot;</span>
    <span class="c1"># double check though this is confirmed already in the config reader</span>
    <span class="n">v_rundir</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">RUNDIR</span><span class="p">])</span></div>



<div class="viewcode-block" id="get_expandable_parameters">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.get_expandable_parameters">[docs]</a>
<span class="k">def</span> <span class="nf">get_expandable_parameters</span><span class="p">(</span>
    <span class="n">user_config</span><span class="p">:</span> <span class="n">ParamMap</span><span class="p">,</span> <span class="n">defaults</span><span class="p">:</span> <span class="n">ParamMap</span><span class="p">,</span> <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_mols</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get configuration expandable blocks.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    user_config : dict</span>
<span class="sd">        The user configuration file for a module.</span>

<span class="sd">    defaults : dict</span>
<span class="sd">        The default configuration file defined for the module.</span>

<span class="sd">    module_name : str</span>
<span class="sd">        The name the module being processed.</span>

<span class="sd">    max_mols : int</span>
<span class="sd">        The max number of molecules allowed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># the topoaa module is an exception because it has subdictionaries</span>
    <span class="c1"># for the `mol` parameter. Instead of defining a general recursive</span>
    <span class="c1"># function, I decided to add a simple if/else exception.</span>
    <span class="c1"># no other module should have subdictionaries has parameters</span>
    <span class="k">if</span> <span class="n">get_module_name</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;topoaa&quot;</span><span class="p">:</span>
        <span class="n">ap</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># allowed_parameters</span>
        <span class="n">ap</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_get_expandable</span><span class="p">(</span><span class="n">user_config</span><span class="p">,</span> <span class="n">defaults</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">max_mols</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_mols</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mol</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
                <span class="n">ap</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="n">_get_expandable</span><span class="p">(</span>
                        <span class="n">user_config</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                        <span class="n">defaults</span><span class="p">[</span><span class="s2">&quot;mol1&quot;</span><span class="p">],</span>
                        <span class="n">module_name</span><span class="p">,</span>
                        <span class="n">max_mols</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">ap</span>

    <span class="k">elif</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">modules_using_resdic</span><span class="p">:</span>
        <span class="n">ep</span> <span class="o">=</span> <span class="n">_get_expandable</span><span class="p">(</span><span class="n">user_config</span><span class="p">,</span> <span class="n">defaults</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">max_mols</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_param</span> <span class="ow">in</span> <span class="n">user_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">_param</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;resdic_&quot;</span><span class="p">):</span>
                <span class="n">ep</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">_param</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ep</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_get_expandable</span><span class="p">(</span><span class="n">user_config</span><span class="p">,</span> <span class="n">defaults</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">max_mols</span><span class="p">)</span></div>



<span class="c1"># reading parameter blocks</span>
<span class="k">def</span> <span class="nf">_get_expandable</span><span class="p">(</span>
    <span class="n">user_config</span><span class="p">:</span> <span class="n">ParamMap</span><span class="p">,</span> <span class="n">defaults</span><span class="p">:</span> <span class="n">ParamMap</span><span class="p">,</span> <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_mols</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="c1"># Set parsing vars</span>
    <span class="n">allowed_params</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">all_counts</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Read single indexed groups (terminating by `_X`)</span>
    <span class="n">news_t1</span><span class="p">,</span> <span class="n">counts_t1</span> <span class="o">=</span> <span class="n">read_single_idx_groups_user_config</span><span class="p">(</span>
        <span class="n">user_config</span><span class="p">,</span>
        <span class="n">get_single_index_groups</span><span class="p">(</span><span class="n">defaults</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="n">allowed_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">news_t1</span><span class="p">)</span>
    <span class="n">all_counts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">counts_t1</span><span class="p">)</span>
    <span class="c1"># Read multiple indexed groups (terminating by `_X_Y`)</span>
    <span class="n">news_t2</span><span class="p">,</span> <span class="n">counts_t2</span> <span class="o">=</span> <span class="n">read_multiple_idx_groups_user_config</span><span class="p">(</span>
        <span class="n">user_config</span><span class="p">,</span>
        <span class="n">get_multiple_index_groups</span><span class="p">(</span><span class="n">defaults</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="n">allowed_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">news_t2</span><span class="p">)</span>
    <span class="n">all_counts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">counts_t2</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">news_t3</span> <span class="o">=</span> <span class="n">read_simplest_expandable</span><span class="p">(</span>
            <span class="n">user_config</span><span class="p">,</span>
            <span class="n">type_simplest_ep</span><span class="p">[</span><span class="n">get_module_name</span><span class="p">(</span><span class="n">module_name</span><span class="p">)],</span>
            <span class="p">)</span>
        <span class="n">allowed_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">news_t3</span><span class="p">)</span>
    <span class="c1"># Read molecule paramters (starting by `mol_`)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">read_mol_parameters</span><span class="p">(</span>
        <span class="n">user_config</span><span class="p">,</span>
        <span class="n">get_mol_parameters</span><span class="p">(</span><span class="n">defaults</span><span class="p">),</span>
        <span class="n">max_mols</span><span class="o">=</span><span class="n">max_mols</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">allowed_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>

    <span class="c1"># Add counted parameters to hidden user parameters</span>
    <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">all_counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">count_param_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;n</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">count_param_name</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">user_config</span><span class="p">[</span><span class="n">count_param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
    <span class="c1"># Return new set of allowed parameters</span>
    <span class="k">return</span> <span class="n">allowed_params</span>


<div class="viewcode-block" id="populate_topology_molecule_params">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.populate_topology_molecule_params">[docs]</a>
<span class="k">def</span> <span class="nf">populate_topology_molecule_params</span><span class="p">(</span><span class="n">topoaa</span><span class="p">:</span> <span class="n">ParamMap</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Populate topoaa `molX` subdictionaries.&quot;&quot;&quot;</span>
    <span class="n">topoaa_dft</span> <span class="o">=</span> <span class="n">_read_defaults</span><span class="p">(</span><span class="s2">&quot;topoaa.1&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">topoaa</span><span class="p">[</span><span class="s2">&quot;molecules&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mol</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">topoaa</span><span class="p">[</span><span class="n">mol</span><span class="p">]</span> <span class="o">=</span> <span class="n">recursive_dict_update</span><span class="p">(</span>
            <span class="n">topoaa_dft</span><span class="p">[</span><span class="s2">&quot;mol1&quot;</span><span class="p">],</span>
            <span class="n">topoaa</span><span class="p">[</span><span class="n">mol</span><span class="p">]</span> <span class="k">if</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">topoaa</span> <span class="k">else</span> <span class="p">{},</span>
        <span class="p">)</span>
    <span class="k">return</span></div>



<div class="viewcode-block" id="populate_mol_parameters">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.populate_mol_parameters">[docs]</a>
<span class="k">def</span> <span class="nf">populate_mol_parameters</span><span class="p">(</span><span class="n">modules_params</span><span class="p">:</span> <span class="n">ParamMap</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Populate modules subdictionaries with the needed molecule `mol_` parameters.</span>

<span class="sd">    The `mol_` prefixed parameters is a subclass of the expandable parameters.</span>

<span class="sd">    See `gear.expandable_parameters`.</span>

<span class="sd">    Modules require these parameters to be repeated for the number of input</span>
<span class="sd">    molecules.</span>

<span class="sd">    This function adds `mol_` parameters to the user input parameters,</span>
<span class="sd">    one per each `molecule`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    modules_params : dict</span>
<span class="sd">        A dictionary containing only modules&#39; keys:subdictionaries</span>
<span class="sd">        parameters. That is, without the general parameters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Alter the dictionary in place.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># the starting number of the `mol_` parameters is 1 by CNS definition.</span>
    <span class="n">num_mols</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">modules_params</span><span class="p">[</span><span class="s2">&quot;topoaa.1&quot;</span><span class="p">][</span><span class="s2">&quot;molecules&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">modules_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># read the modules default parameters</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="n">_read_defaults</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>

        <span class="c1"># if there are no `mol_` parameters in the modules default values,</span>
        <span class="c1"># the `mol_params` generator will be empty and the for-loop below</span>
        <span class="c1"># won&#39;t run.</span>
        <span class="n">mol_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">defaults</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">is_mol_parameter</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">mol_params</span><span class="p">,</span> <span class="n">num_mols</span><span class="p">):</span>
            <span class="n">param_name</span> <span class="o">=</span> <span class="n">remove_trail_idx</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

            <span class="c1"># the `setdefault` grants that the value is only added if</span>
            <span class="c1"># the parameter is not present.</span>
            <span class="n">modules_params</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">defaults</span><span class="p">[</span><span class="n">param</span><span class="p">],</span>
            <span class="p">)</span>
    <span class="k">return</span></div>



<div class="viewcode-block" id="check_if_path_exists">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.check_if_path_exists">[docs]</a>
<span class="k">def</span> <span class="nf">check_if_path_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">FilePath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a path exists and raises an error if it does not exist.</span>

<span class="sd">    For example given this path &quot;../config/project_01/file.txt&quot; it would find</span>
<span class="sd">    the following path &quot;../config/project-01&quot;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : AnyStr | PathLike</span>
<span class="sd">        The path to check.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        If the path does exist.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the path does not exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">reconstituted_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span>
    <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">parts</span>
    <span class="k">if</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
        <span class="n">next_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">reconstituted_path</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">next_folder</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">error</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">reconstituted_path</span><span class="p">,</span>
                <span class="n">fuzzy_match</span><span class="p">([</span><span class="n">part</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">reconstituted_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">part</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">break</span>
        <span class="n">reconstituted_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">next_folder</span><span class="p">)</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;The following file could not be found: &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;In the folder &#39;</span><span class="si">{</span><span class="n">error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; the following &#39;</span><span class="si">{</span><span class="n">error</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;is the closest match to the supplied &#39;</span><span class="si">{</span><span class="n">error</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;, did &quot;</span>
        <span class="s2">&quot;you mean to open this?&quot;</span>
    <span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="fuzzy_match">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.fuzzy_match">[docs]</a>
<span class="k">def</span> <span class="nf">fuzzy_match</span><span class="p">(</span>
    <span class="n">user_input</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">possibilities</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the closest possibility to the user supplied input.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    user_input : list(string)</span>
<span class="sd">        List of strings with the faulty input given by the user.</span>

<span class="sd">    possibilities : list(string)</span>
<span class="sd">        List of strings with all possible options that would be</span>
<span class="sd">        valid in this context.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list(string, string)</span>
<span class="sd">        The closest string from the possibilities to each string of the</span>
<span class="sd">        `user_input`. With as first element of the tuple the user_input</span>
<span class="sd">        string, and as second element the matched possibility.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">user_word</span> <span class="ow">in</span> <span class="n">transform_to_list</span><span class="p">(</span><span class="n">user_input</span><span class="p">):</span>
        <span class="n">best</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">possibility</span> <span class="ow">in</span> <span class="n">possibilities</span><span class="p">:</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">SequenceMatcher</span><span class="p">(</span>
                <span class="n">a</span><span class="o">=</span><span class="n">user_word</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">possibility</span>
            <span class="p">)</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span>  <span class="c1"># noqa: E501</span>
            <span class="k">if</span> <span class="n">distance</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">best</span> <span class="o">=</span> <span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">possibility</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">user_word</span><span class="p">,</span> <span class="n">best</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">results</span></div>



<div class="viewcode-block" id="update_step_contents_to_step_names">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.update_step_contents_to_step_names">[docs]</a>
<span class="k">def</span> <span class="nf">update_step_contents_to_step_names</span><span class="p">(</span>
    <span class="n">prev_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">new_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">folder</span><span class="p">:</span> <span class="n">FilePath</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update step folder names in files after the `--restart` option.</span>

<span class="sd">    Runs over the folders defined in `new_names`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prev_names : list</span>
<span class="sd">        List of step names to find in file contents.</span>

<span class="sd">    new_names : list</span>
<span class="sd">        List of new step names to replace `prev_names`. Both lists need</span>
<span class="sd">        to be synchronized. That is, the first index of `prev_names` should</span>
<span class="sd">        correspond to the old names of `new_names`.</span>

<span class="sd">    folder : str or Path</span>
<span class="sd">        Folder where the step folders are. Usually run directory or</span>
<span class="sd">        data directory.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Save files in place.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">new_step</span> <span class="ow">in</span> <span class="n">new_names</span><span class="p">:</span>
        <span class="n">new_step_p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">new_step</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file_</span> <span class="ow">in</span> <span class="n">new_step_p</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
            <span class="c1"># goes recursive into the next folder</span>
            <span class="k">if</span> <span class="n">file_</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">update_step_names_in_subfolders</span><span class="p">(</span><span class="n">file_</span><span class="p">,</span> <span class="n">prev_names</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">update_step_names_in_file</span><span class="p">(</span><span class="n">file_</span><span class="p">,</span> <span class="n">prev_names</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span></div>



<div class="viewcode-block" id="update_step_names_in_subfolders">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.update_step_names_in_subfolders">[docs]</a>
<span class="k">def</span> <span class="nf">update_step_names_in_subfolders</span><span class="p">(</span>
    <span class="n">folder</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">prev_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">new_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update step names in subfolders.</span>

<span class="sd">    Some modules may generate subfolders. This function update</span>
<span class="sd">    its files accordingly to the `--restart` feature.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">file_</span> <span class="ow">in</span> <span class="n">folder</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">file_</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">update_step_names_in_subfolders</span><span class="p">(</span><span class="n">file_</span><span class="p">,</span> <span class="n">prev_names</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">update_step_names_in_file</span><span class="p">(</span><span class="n">file_</span><span class="p">,</span> <span class="n">prev_names</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span>
    <span class="k">return</span></div>



<div class="viewcode-block" id="update_step_names_in_file">
<a class="viewcode-back" href="../../../reference/gear/haddock.gear.prepare_run.html#haddock.gear.prepare_run.update_step_names_in_file">[docs]</a>
<span class="k">def</span> <span class="nf">update_step_names_in_file</span><span class="p">(</span>
    <span class="n">file_</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">prev_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">new_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update step names in file following the `--restart` option.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">file_</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to read file </span><span class="si">{</span><span class="n">file_</span><span class="si">}</span><span class="s2">. Error is </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">prev_names</span><span class="p">,</span> <span class="n">new_names</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>
    <span class="n">file_</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, BonvinLab.
      <span class="lastupdated">Last updated on Oct 29, 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>